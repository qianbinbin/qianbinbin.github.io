<!doctype html><html lang=zh><meta charset=utf-8><meta name=generator content="Hugo 0.136.2"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light dark"><meta name=supported-color-schemes content="light dark"><link rel=icon href=/favicons/favicon.svg><title>移植 Samba 到 iOS 平台&nbsp;&ndash;&nbsp;Binac</title><link rel=stylesheet href=/css/core.min.d30edcc615d78b7f8a2a9e5f1b66bd074a7ad2e94b579fa5902d0967ce0f7684b300ef3a9e15d41af82c75f3fb951d4b.css integrity=sha384-0w7cxhXXi3+KKp5fG2a9B0p60ulLV5+lkC0JZ84PdoSzAO86nhXUGvgsdfP7lR1L><meta name=twitter:card content="summary">
<meta name=twitter:title content="移植 Samba 到 iOS 平台"><body><section id=header><div class="header wrap"><span class="header left-side"><a class="site home" href=/><img class="site logo" src=/favicons/favicon.svg alt><span class="site name">Binac</span></a></span>
<span class="header right-side"><div class="nav wrap"><nav class=nav><a class='nav item active' href=/posts/ title=文章>文章</a>
<a class='nav item' href=/nonsense/ title=妄言>妄言</a>
<a class='nav item' href=/tuya/ title=涂鸦>涂鸦</a>
<a class='nav item' href=/tags/ title>标签</a></nav></div></span></div></section><section id=content><div class=article-container><section class="article header"><h1 class="article title">移植 Samba 到 iOS 平台</h1><p class="article date">2019-09-08</p></section><article class="article markdown-body"><h2 id=前言>前言</h2><p>iOS 越狱后可以像树莓派那样作为迷你服务器，在上面搭建 aria2、Transmission 等。但是 Cydia 上的 Samba 非常古老，而且只能在 32 位 CPU 上运行。</p><p>于是我开始寻找替代方案：</p><ol><li>用其他协议，例如 ftp、nfs 等</li><li>用 web 文件管理器</li><li>从源码交叉编译 Samba</li><li>在 iOS 端用 Cydia 上的 LLVM 工具链从源码编译 Samba</li></ol><p>其中 ftp 似乎对流媒体支持并不好，nfs 有个开源项目 NFS-Ganesha，但是交叉编译依赖难以处理。经过一番挣扎后，这种方案被放弃了。</p><p>Web 服务器的话，Cydia 上也没有 Nginx，PHP 倒是有，主要担心的是即使服务器搭好了，搭建前端又要处理一堆依赖。而且用浏览器进行文件管理终究不爽。</p><p>后来尝试了一个用 Go 语言编写的 web 文件管理器 <a href=https://filebrowser.xyz/ target=_blank rel="noopener noreferrer">File Browser</a>，交叉编译后发现可以运行，但浏览器打开就是不能使用。给他们提了 issue，一直没有回复，这个项目在招募维护者，看样子不会很快处理了。</p><p>Samba 如果能跑当然是最好的方案了，但是用官方的最新源码按照<a href=https://wiki.samba.org/index.php/Waf target=_blank rel="noopener noreferrer">官方文档</a>中的交叉编译方法来编译的话，是无法编译到 iOS 平台的。如果想尝试建议不要浪费这个时间。iOS 端直接编译也尝试过，就算忽略孱弱的性能，configure 过程死活要尝试运行测试程序，而 iOS 端都必须签名才能运行。</p><p><a href=http://www.skyfox.org/ios-macos-kxsmb-smb-build.html target=_blank rel="noopener noreferrer">iOS开发之macOS下kxsmb编译smb类库-天狐博客</a> 中的方法是编译出几个特定的类库，我将编译脚本中的编译命令改为<code>make</code>后编译出错，报什么错已经忘了，后来没有再尝试，感觉上应该可行。</p><p>最后我找了一个比较老的 4.0.8 版本，磕磕绊绊后终于成功了，虽然<code>nmbd</code>还是无法运行，但<code>smbd</code>可以跑了，已经可以满足我的需求。</p><h2 id=编译过程>编译过程</h2><p>下载源码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>wget https://download.samba.org/pub/samba/stable/samba-4.0.8.tar.gz
</span></span><span class=line><span class=cl>tar zxf samba-4.0.8.tar.gz
</span></span></code></pre></div><p>进入 source3 目录，而不是源码根目录：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=nb>cd</span> samba-4.0.8/source3
</span></span></code></pre></div><p>之所以用老版本，是因为比较新的几个版本 source3 目录下是没有 configure 或 autogen.sh 的，而根目录下的 configure 文件无法正确配置 iOS 的交叉编译环境。</p><p>新建一个文件 cache-file.cache 用于保存配置的变量：</p><pre tabindex=0><code>samba_cv_big_endian=no
samba_cv_little_endian=yes
samba_cv_CC_NEGATIVE_ENUM_VALUES=yes
libreplace_cv_HAVE_GETADDRINFO=no
samba_cv_HAVE_WRFILE_KEYTAB=no
smb_krb5_cv_enctype_to_string_takes_krb5_context_arg=no
smb_krb5_cv_enctype_to_string_takes_size_t_arg=yes
ac_cv_file__proc_sys_kernel_core_pattern=yes
</code></pre><p>这个文件 configure 后会被脚本改写。</p><p>运行配置脚本：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>./configure <span class=nv>CC</span><span class=o>=</span><span class=k>$(</span>xcrun -sdk iphoneos -find clang<span class=k>)</span> <span class=nv>LD</span><span class=o>=</span><span class=k>$(</span>xcrun -sdk iphoneos -find ld<span class=k>)</span> <span class=nv>AR</span><span class=o>=</span><span class=k>$(</span>xcrun -sdk iphoneos -find ar<span class=k>)</span> <span class=nv>CFLAGS</span><span class=o>=</span><span class=s2>&#34;-isysroot </span><span class=k>$(</span>xcrun --sdk iphoneos --show-sdk-path<span class=k>)</span><span class=s2> -target arm64-apple-darwin -arch arm64&#34;</span> <span class=nv>LDFLAGS</span><span class=o>=</span><span class=s2>&#34;-isysroot </span><span class=k>$(</span>xcrun --sdk iphoneos --show-sdk-path<span class=k>)</span><span class=s2> -arch arm64&#34;</span> --host<span class=o>=</span>arm-apple-darwin --cache-file<span class=o>=</span>cache-file.cache
</span></span></code></pre></div><p>其他编译参数可以 <code>./configure --help</code> 查看。例如不设置 <code>prefix</code> 参数的话，默认安装路径就是 <code>/usr/local/samba</code>。</p><p>但是生成的配置还有一些不正确，可以手动修改 <code>include/autoconf/config.h</code>：</p><ul><li><code>#define HAVE_YP_GET_DEFAULT_DOMAIN 1</code>注释掉，否则编译出错</li><li><code>SIZEOF_BLKCNT_T_8</code>宏取消注释，改为<code>#define SIZEOF_BLKCNT_T_8</code>，否则编译出错</li><li><code>USE_SETREUID</code>宏取消注释，改为<code>#define USE_SETREUID 1</code>，否则运行出错，需要查看 log 才能发现</li></ul><p>这个时候就可以 <code>make -j8</code> 了。但是编译仍然会出错，主要是 iOS 修改了 API。一个是缺少 <code>crt_externs.h</code> 头文件，还有一个 <code>system(cmd)</code> 改为 <code>popen(cmd, "r")</code>，具体解决方法可以看编译 kxsmb 那篇文章。</p><p>编译很快，完成后新建一个目录：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>mkdir -p build-ios/usr/local/samba
</span></span></code></pre></div><p>然后安装</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>make install <span class=nv>prefix</span><span class=o>=</span>/path/to/build-ios/usr/local/samba
</span></span></code></pre></div><p>DESTDIR 变量是不起作用的，这个要注意，一不小心安装到本机上就难受了。</p><p>其中 <code>bin</code>、<code>include</code>、<code>lib</code>、<code>sbin</code> 等文件夹均不在常见的系统默认路径中，安装到 iOS 的话还要手动添加，我索性把这几个目录直接放到 <code>usr/local</code> 下了。</p><p>不要忘了给二进制文件签名，包括 <code>bin</code>、<code>sbin</code> 下的可执行文件和 <code>lib</code> 下的库文件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>codesign --force --sign xxx --entitlements /path/to/ent.xml file-to-sign
</span></span></code></pre></div><p><code>sign</code> 参数可以通过 <code>security find-identity -v -p codesigning</code> 来获取。</p><p>然后再用 <code>dpkg</code> 打个包，方便 iOS 端安装卸载。在 <code>build-ios</code> 目录下新建 <code>DEBIAN</code> 文件夹，并在其中新建 <code>control</code> 文件，内容如下：</p><pre tabindex=0><code>Package: samba
Version: 4.0.8
Priority: optional
Section: Networking
Maintainer: MaintainerName
Author: AuthorName
Description: Windows (SMB/CIFS) filesharing and networking
Architecture:iphoneos-arm
</code></pre><p>然后：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>dpkg -b build-ios samba_4.0.8-0_arm64.deb
</span></span></code></pre></div><p>然后 <code>scp</code> 到设备上安装。</p><p>仍然无法运行，查看 log 发现有文件权限问题、缺少配置文件等，这些都容易解决，就不赘述了。</p><p>再说说 <code>USE_SETREUID</code> 这个宏，如果不设置的话，<code>smbd</code> 就会出错：</p><pre tabindex=0><code>[2019/09/08 02:22:50.992604,  0] lib/util_sec.c:121(assert_gid)
  Failed to set gid privileges to (-1,501) now set to (0,0) uid=(0,0)
[2019/09/08 02:22:50.994642,  0] lib/util.c:810(smb_panic_s3)
  PANIC (pid 1150): failed to set gid
</code></pre><p>查看 <code>lib/util_sec.c</code> 文件 <code>gain_root_group_privilege</code> 函数，没时间看整个模块的逻辑（而且代码写得没有让人看的欲望……），从这个函数来看是在设置 gid 时出错，定位函数中的几个宏发现是没有找到合适的系统函数，但在 iOS API 中是存在的，在 <code>include/autoconf/config.h</code> 中改一下，重新编译就可以了。其他几个类似的宏如果系统也有对应函数接口的话应该也可行，懒得尝试了。</p><p>最重要的是 <code>smbpasswd</code> 和 <code>smbd</code> 都可以运行了。</p><p><code>nmbd</code> 无法使用，查看其 log 发现是在 <code>../lib/socket/interfaces.c</code> 中 <code>get_interfaces</code> 函数调用 <code>TYPESAFE_QSORT</code> 产生的，这个宏包装了 <code>qsort</code>，然后对前两个元素大小进行 <code>assert</code>，逻辑上没什么问题，怀疑是 <code>compare</code> 函数有问题，但是实在不想看了。<code>get_interfaces</code> 这个函数主要逻辑就是将一个数组排序，然后去重，但是去重算法写成这样真让人头大：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/* this wrapper is used to remove duplicates from the interface list generated
</span></span></span><span class=line><span class=cl><span class=cm>   above */</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>get_interfaces</span><span class=p>(</span><span class=n>TALLOC_CTX</span> <span class=o>*</span><span class=n>mem_ctx</span><span class=p>,</span> <span class=k>struct</span> <span class=n>iface_struct</span> <span class=o>**</span><span class=n>pifaces</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>struct</span> <span class=n>iface_struct</span> <span class=o>*</span><span class=n>ifaces</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>total</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>total</span> <span class=o>=</span> <span class=nf>_get_interfaces</span><span class=p>(</span><span class=n>mem_ctx</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>ifaces</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>total</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=k>return</span> <span class=n>total</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=cm>/* now we need to remove duplicates */</span>
</span></span><span class=line><span class=cl>        <span class=nf>TYPESAFE_QSORT</span><span class=p>(</span><span class=n>ifaces</span><span class=p>,</span> <span class=n>total</span><span class=p>,</span> <span class=n>iface_comp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=n>i</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=n>i</span><span class=o>&lt;</span><span class=n>total</span><span class=p>;)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nf>iface_comp</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ifaces</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>],</span> <span class=o>&amp;</span><span class=n>ifaces</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=k>for</span> <span class=p>(</span><span class=n>j</span><span class=o>=</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>;</span><span class=n>j</span><span class=o>&lt;</span><span class=n>total</span><span class=o>-</span><span class=mi>1</span><span class=p>;</span><span class=n>j</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                <span class=n>ifaces</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>ifaces</span><span class=p>[</span><span class=n>j</span><span class=o>+</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>                        <span class=n>total</span><span class=o>--</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>i</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=o>*</span><span class=n>pifaces</span> <span class=o>=</span> <span class=n>ifaces</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>total</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>还好 <code>nmbd</code> 对我来说没什么卵用，忽略了。</p><h2 id=参考资料>参考资料</h2><ol><li><a href=http://www.skyfox.org/ios-macos-kxsmb-smb-build.html target=_blank rel="noopener noreferrer">iOS开发之macOS下kxsmb编译smb类库-天狐博客</a></li><li><a href=https://blog.csdn.net/kingdragonfly120/article/details/10044605 target=_blank rel="noopener noreferrer">MINI2440 samba移植笔记 - 且行且珍惜 - CSDN博客</a></li></ol></article><section class="article labels"><a class=tag href=/tags/ios/>iOS</a><a class=tag href=/tags/%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91/>交叉编译</a></section><section class="article license"><p xmlns:cc=http://creativecommons.org/ns# style=text-align:center>本作品根据 <a href=http://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank rel="license noopener noreferrer" style=display:inline-block>署名-非商业性使用-相同方式共享 4.0 国际许可<img style=height:15px!important;margin-left:1px;vertical-align:text-bottom src=/cc-icons/cc.svg><img style=height:15px!important;margin-left:1px;vertical-align:text-bottom src=/cc-icons/by.svg><img style=height:15px!important;margin-left:1px;vertical-align:text-bottom src=/cc-icons/nc.svg><img style=height:15px!important;margin-left:1px;vertical-align:text-bottom src=/cc-icons/sa.svg></a> 进行授权。</p></section></div><div class="article bottom"><section class="article navigation"><p><a class=link href=/posts/strategy-pattern/><span class="iconfont icon-article"></span>策略模式 Strategy Pattern</a></p><p><a class=link href=/posts/cross-compile-frp-for-ios/><span class="iconfont icon-article"></span>交叉编译 Go 语言项目 frp for iOS</a></p></section><section class="article discussion"><script>function loadComment(){let e=document.createElement("script");e.src="https://utteranc.es/client.js",e.setAttribute("repo","qianbinbin/qianbinbin.github.io"),e.setAttribute("issue-term","pathname"),e.setAttribute("theme","preferred-color-scheme"),e.setAttribute("crossorigin","anonymous"),e.setAttribute("async",""),document.querySelector("section.article.discussion").innerHTML="",document.querySelector("section.article.discussion").appendChild(e)}loadComment(),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{loadComment()})</script></section></div></section><section id=footer><div class=footer-wrap><p class=copyright>© 2017-2024 Binac.</p></div></section><script async src="https://www.googletagmanager.com/gtag/js?id=G-N7VZY53PLB"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-N7VZY53PLB")}</script><script src=https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js></script><script>addBackToTop({diameter:42})</script></body></html>