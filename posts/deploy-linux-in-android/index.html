<!doctype html><html lang=zh><meta charset=utf-8><meta name=generator content="Hugo 0.136.2"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light dark"><meta name=supported-color-schemes content="light dark"><link rel=icon href=/favicons/favicon.svg><title>在 Android 上部署 Linux&nbsp;&ndash;&nbsp;Binac</title><link rel=stylesheet href=/css/core.min.d30edcc615d78b7f8a2a9e5f1b66bd074a7ad2e94b579fa5902d0967ce0f7684b300ef3a9e15d41af82c75f3fb951d4b.css integrity=sha384-0w7cxhXXi3+KKp5fG2a9B0p60ulLV5+lkC0JZ84PdoSzAO86nhXUGvgsdfP7lR1L><meta name=twitter:card content="summary">
<meta name=twitter:title content="在 Android 上部署 Linux"><body><section id=header><div class="header wrap"><span class="header left-side"><a class="site home" href=/><img class="site logo" src=/favicons/favicon.svg alt><span class="site name">Binac</span></a></span>
<span class="header right-side"><div class="nav wrap"><nav class=nav><a class='nav item active' href=/posts/ title=文章>文章</a>
<a class='nav item' href=/nonsense/ title=妄言>妄言</a>
<a class='nav item' href=/tuya/ title=涂鸦>涂鸦</a>
<a class='nav item' href=/tags/ title>标签</a></nav></div></span></div></section><section id=content><div class=article-container><section class="article header"><h1 class="article title">在 Android 上部署 Linux</h1><p class="article date">2023-03-27<span class=lastmod> • 更新于 2024-02-20</span></p></section><article class="article markdown-body"><p>在 Android 上部署 Linux……好吧，我知道 Android 本身就是个 Linux。不要在意这些细节。</p><p>最近把旧手机当时钟用，发现它还有 TF 卡槽，想起何不在上面跑个 Linux，化身低功耗服务器呢，再搭个 Syncthing 私人云盘，岂不美哉（摊手）？</p><p>为啥不直接用 Syncthing APP？<del>呃，你不觉得这样很酷吗？我觉得太酷了……</del></p><p><del>为了物尽其用，又买了个 TF 卡……</del></p><p>长话短说，就是用 <a href=https://github.com/meefik/linuxdeploy target=_blank rel="noopener noreferrer">Linux Deploy</a>，它能以 chroot 方式在 Android 上创建 Linux 环境。和 Termux 相比，它更像一个完整的 Linux。</p><p>其实很早就用过 LP，不过 LP 看起来有段时间没更新了，一大堆 issue 没人理。新手要踩的坑还是很多的，特此记录。</p><h2 id=安装>安装</h2><p>首先，用 <a href=https://github.com/topjohnwu/Magisk target=_blank rel="noopener noreferrer">Magisk</a> 把手机 root 了。Android 版本太老的话是没法使用新版 Magisk APP 的，在 release 页找老版 Magisk。</p><p>其次，把 VPN 之类的关掉（装完再关也可以），那玩意会在手机上建 NAT，局域网设备就没法通过 IP 地址访问了。鬼知道我在这个奇葩问题上花了多少时间……</p><p>如果要爬梯，可以用这个 <a href=https://github.com/yatsuki/v2ray target=_blank rel="noopener noreferrer">V2Ray Magisk 模块</a>，它能在手机建立透明代理。虽然版本很老，也有一些 bug，但确实能用。</p><p>打开 LP，右下角选项，发行版就用 Debian。并不是所有发行版都能用，既然 LP 默认 Debian，意味着它的问题可能是最少的。目前 Debian 最新只能用 buster。</p><p>架构就按自己手机来。</p><p>官方的源经常访问故障，建议使用国内镜像服务，比如清华源 <code>http://mirrors.tuna.tsinghua.edu.cn/debian/</code>，注意是 <code>http</code> 而不是 <code>https</code>。</p><p>安装类型，我是直接把环境安装到 TF 卡，所以选择分区，而不是镜像文件或目录。这样不仅保持 Linux 环境和 Android 相互独立，而且读写性能比镜像文件更好。</p><p>具体做法是，先把 TF 卡分区为单个 ext4，当然如果你知道你在做什么，也可以建立其它分区，只要下面的安装路径正确即可。</p><p>插入 TF 卡，万恶的 Android 会自动挂载，然后在里面拉屎。先不要管它，在设置里把 TF 卡弹出。</p><p>安装路径一般为 <code>/dev/block/mmcblk1p1</code>，根据自己的来，可以使用终端、文件管理器等查看。</p><p>初始化系统使用 SysV。chroot 环境是不能用 systemd 的。不建议尝试那些模拟 systemd 的替代品，SysV 和 cron 就可以解决大部分问题。</p><p>启用 ssh，不要 GUI。</p><p>其它的按自己的喜好来。</p><p>安装只要十几分钟就搞定了，如果出现问题，到 LP 设置里把调试打开看看 log。</p><p>然后启动就能用 ssh 访问了。</p><p>另外，由于 Android 省电机制，关闭屏幕后会非常卡，除非保持在 LP 主界面，或安装禁止关屏的 APP。LP 设置里有保持 Wi-Fi 和 CPU 的选项，但用处不大，至少在高版本 Android 是不管用的。</p><h2 id=天坑>天坑</h2><h3 id=etcrclocal>/etc/rc.local</h3><p>虽然有 SysV，但很多软件都转用 systemd了。</p><p>这时肯定想到 <code>/etc/rc.local</code> 开机脚本，然而它也缺失了。啊这……</p><p>所以我们需要手动建立 <code>/etc/init.d/rc.local</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=cp>#! /bin/sh
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1>### BEGIN INIT INFO</span>
</span></span><span class=line><span class=cl><span class=c1># Provides:          rc.local</span>
</span></span><span class=line><span class=cl><span class=c1># Required-Start:    $all</span>
</span></span><span class=line><span class=cl><span class=c1># Required-Stop:</span>
</span></span><span class=line><span class=cl><span class=c1># Default-Start:     2 3 4 5</span>
</span></span><span class=line><span class=cl><span class=c1># Default-Stop:</span>
</span></span><span class=line><span class=cl><span class=c1># Short-Description: Run /etc/rc.local if it exist</span>
</span></span><span class=line><span class=cl><span class=c1>### END INIT INFO</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># https://forums.raspberrypi.com/viewtopic.php?t=95101</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>PATH</span><span class=o>=</span>/sbin:/usr/sbin:/bin:/usr/bin
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>. /lib/init/vars.sh
</span></span><span class=line><span class=cl>. /lib/lsb/init-functions
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>do_start<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>[</span> -x /etc/rc.local <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>                <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$VERBOSE</span><span class=s2>&#34;</span> !<span class=o>=</span> no <span class=o>]</span> <span class=o>&amp;&amp;</span> log_begin_msg <span class=s2>&#34;Running local boot scripts (/etc/rc.local)&#34;</span>
</span></span><span class=line><span class=cl>                /etc/rc.local
</span></span><span class=line><span class=cl>                <span class=nv>ES</span><span class=o>=</span><span class=nv>$?</span>
</span></span><span class=line><span class=cl>                <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$VERBOSE</span><span class=s2>&#34;</span> !<span class=o>=</span> no <span class=o>]</span> <span class=o>&amp;&amp;</span> log_end_msg <span class=nv>$ES</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=nv>$ES</span>
</span></span><span class=line><span class=cl>        <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>case</span> <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span> in
</span></span><span class=line><span class=cl>    start<span class=o>)</span>
</span></span><span class=line><span class=cl>        do_start
</span></span><span class=line><span class=cl>        <span class=p>;;</span>
</span></span><span class=line><span class=cl>    restart<span class=p>|</span>reload<span class=p>|</span>force-reload<span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;Error: argument &#39;</span><span class=nv>$1</span><span class=s2>&#39; not supported&#34;</span> &gt;<span class=p>&amp;</span><span class=m>2</span>
</span></span><span class=line><span class=cl>        <span class=nb>exit</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>        <span class=p>;;</span>
</span></span><span class=line><span class=cl>    stop<span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=p>;;</span>
</span></span><span class=line><span class=cl>    *<span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;Usage: </span><span class=nv>$0</span><span class=s2> start|stop&#34;</span> &gt;<span class=p>&amp;</span><span class=m>2</span>
</span></span><span class=line><span class=cl>        <span class=nb>exit</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>        <span class=p>;;</span>
</span></span><span class=line><span class=cl><span class=k>esac</span>
</span></span></code></pre></div><p>以及 <code>/etc/rc.local</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=cp>#!/bin/sh -e
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># rc.local</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># This script is executed at the end of each multiuser runlevel.</span>
</span></span><span class=line><span class=cl><span class=c1># Make sure that the script will &#34;exit 0&#34; on success or any other</span>
</span></span><span class=line><span class=cl><span class=c1># value on error.</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># In order to enable or disable this script just change the execution</span>
</span></span><span class=line><span class=cl><span class=c1># bits.</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># By default this script does nothing.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp /etc/hostname /proc/sys/kernel/hostname
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>rm -rf /Android
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod <span class=m>666</span> /dev/fuse
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>exit</span> <span class=m>0</span>
</span></span></code></pre></div><p>给它们加上可执行权限，然后用 <code>sysv-rc-conf</code> 或者其它你喜欢的工具启用。</p><p>看看我已经在 <code>rc.local</code> 里加了什么内容：</p><ul><li><code>/etc/hostname</code> 中的内容不会被读取，所以这里把它复制一下。</li><li>Android 开机就会自动挂载 TF 卡并在里面拉屎，所以把屎目录 <code>Android</code> 删掉。而且挂载之后，LP 就没法启动了，这个坑之后再说，如何在开机时取消挂载。</li><li><code>/dev/fuse</code> 由于权限限制需要修改一下，否则无法使用 Rclone 等工具。</li></ul><p>TNND，这 TM 都是坑啊。</p><h3 id=关闭-rsyslog>关闭 rsyslog</h3><p>Android 的 loglevel 开到了 7，那不是一般的多：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># cat /proc/sys/kernel/printk</span>
</span></span><span class=line><span class=cl>7	4	1	<span class=m>7</span>
</span></span></code></pre></div><p>而且手动去改也是没用的，估计是因为全被 logcat 接管了。</p><p>LP 启动没多久，<code>/var/log</code> 大小就按 GiB 来计算了，非常坑爹，嫌闪存长寿啊。</p><p>也考虑过使用 zram 分区，但自带的 logrotate 似乎有 bug，配置不生效，而且不知道 zram 在 chroot 下能否正常使用，等有空再折腾吧。</p><p>最后干脆直接用 <code>sysv-rc-conf</code> 关闭了 rsyslog。</p><p>清净了！</p><h3 id=开机取消挂载-tf-卡>开机取消挂载 TF 卡</h3><p>之前已经把环境安装到 TF 卡了，如果想让 LP 开机启动，就不能让系统挂载 TF 卡。</p><p>我研究了一下，开机禁止挂载比较麻烦，除非修改源码，但开机自动挂载后再手动取消挂载（弹出）就容易得多。</p><p>于是我写了个 Magisk 开机脚本：</p><script src="https://gist.github.com/qianbinbin/e93e19940dda264cc5cd2ebdddbe565e.js?file=unmount.sh"></script><p>它会弹出所有外置存储，比如 TF 卡、U 盘等。</p><p>由于脚本里使用了 <code>sm</code> 工具，需要 Android 6.0 以上才能用。</p><p>把脚本放到 <code>/data/adb/service.d/</code> 下重启，看看是不是一挂载就马上弹出了。如果不成功，把 <code>LOG_ON=false</code> 改为 <code>LOG_ON=true</code> ，查看 <code>/data/local/tmp/unmount.log</code> 排查一下原因。</p><p>我自己测试，一般在开机后 20 多秒就会弹出，比 LP 启动快。如果弹出太慢，建议把 LP 启动延迟改大一些。</p><h2 id=服务>服务</h2><h3 id=syncthing>Syncthing</h3><p>使用 <a href=https://apt.syncthing.net/ target=_blank rel="noopener noreferrer">官方仓库</a> 安装。配置略。</p><h3 id=rclone>Rclone</h3><p>参考我的文章：<a href=/posts/rclone/>使用 Rclone 挂载网盘</a>。</p><h3 id=nginx>Nginx</h3><p><a href=https://nginx.org/en/linux_packages.html#Debian target=_blank rel="noopener noreferrer">Nginx 官方仓库</a>里只有 arm64 和 amd64，32 位的手机就用默认仓库里的老版本吧。</p><p>Nginx 一大好处是给搭建反向代理，比如：</p><pre tabindex=0><code>location /your-syncthing-path/ {
    proxy_pass https://localhost:8384/;
    ...
}
</code></pre><p>Transmission、aria2 等下载工具都可以这么干，对外隐藏真实端口，更重要的是可以走 HTTPS。今天在网上用 HTTP 和裸奔有什么区别？</p><p>好了，再填一个大坑，给你节省半天时间：</p><p><strong>由于 Android 权限限制，必须把 <code>www-data</code> 加入 <code>aid_inet</code> 用户组：</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># usermod -aG aid_inet www-data</span>
</span></span></code></pre></div><p>否则没法使用。所以 Android 真不能当作普通的 Linux 发行版……</p><h3 id=certbot>certbot</h3><p>certbot 用 apt 安装即可，版本虽老但够用。用 pip 安装的话会给你装 20 几个依赖，人麻了……apt 虽然也有，但起码可以 <code>autoremove</code>。</p><p>国内 ISP 屏蔽了普通用户的 80 端口，要申请证书可以参考<a href=https://www.digitalocean.com/community/tutorials/how-to-acquire-a-let-s-encrypt-certificate-using-dns-validation-with-acme-dns-certbot-on-ubuntu-18-04 target=_blank rel="noopener noreferrer">这篇文章</a>。</p><p>另外，certbot 是没有 SysV 脚本的，要自动更新可以直接添加到 cron，比如每天更新两次 <code>0 0,12 * * * /usr/bin/certbot -q renew</code>，跟 systemd 脚本是一样的效果。</p><h2 id=其它>其它</h2><h3 id=永久开启无线调试>永久开启无线调试</h3><p>打开终端或 <code>adb shell</code>，使用 <code>su</code> 获取 root 权限后输入：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># setprop persist.adb.tcp.port 5555</span>
</span></span></code></pre></div><p>重启以后也会保持开启。</p><p><strong>注意切不可在公网上开启！Android 漏洞极多，尤其是老旧版本，非常容易成为肉鸡！</strong></p><h3 id=关闭旋转建议按钮>关闭旋转建议按钮</h3><p>我就好奇什么样的低能玩意设计出了这么个脑瘫功能？</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ adb shell settings put secure show_rotation_suggestions <span class=m>0</span>
</span></span></code></pre></div><h3 id=充电控制>充电控制</h3><p>据说手机常年通电，电池容易鼓包，有搞硬件的大佬会把电池去掉，让主板直接从 USB 取电，我是不想折腾，总有种因噎废食的感觉，万一断电了呢？硬件损伤且不说，数据丢失就很难受。</p><p>其实，一个 <a href=https://github.com/VR-25/acc target=_blank rel="noopener noreferrer">ACC Magisk 模块</a>就可以搞定，安装完直接重启，默认配置就够用了。它会让手机电量保持在 70 ~ 75，电量低了就充电，高了就断电，省心得很。</p><h3 id=f-droid-特权扩展>F-Droid 特权扩展</h3><p>F-Droid 不能自动安装 APP，root 也不行。官方有一个<a href=https://f-droid.org/en/packages/org.fdroid.fdroid.privileged.ota/ target=_blank rel="noopener noreferrer">特权扩展 OTA 包</a>，可以通过 recovery 刷入。但这会修改 system 分区，我不喜欢。</p><p>Magisk 官方模块仓库（已废弃）倒是有一个模块，但一来版本太老，二来写得不咋地，三来作者是个 GD……真晦气。</p><p>于是我大体看了一下 Magisk 官方文档，自己写了个模块：<a href=https://github.com/qianbinbin/fdroid-priv-ext target=_blank rel="noopener noreferrer">F-Droid 特权扩展</a>，通过 GitHub Actions 自动构建，与 F-Droid 官方保持同步。</p><p>需要注意的是，<strong>安装模块后 F-Droid 网络访问权限可能会丢失</strong>，要重新设置一下。这也是个大坑，因为没有任何有用的提示，你会一直怀疑是自己网络问题，然后浪费几个小时调试。</p><h3 id=远程控制>远程控制</h3><p>由于是作为服务器用的，远程控制还是很有用的。</p><p>我试过很多 VNC 软件，都不靠谱。</p><p>最后发现了神器：<a href=https://www.coolapk.com/apk/com.didjdk.adbhelper target=_blank rel="noopener noreferrer">甲壳虫</a>，它基于 <a href=https://github.com/Genymobile/scrcpy target=_blank rel="noopener noreferrer">scrcpy</a>，通过 adb 控制手机。结合前面永久开启无线调试，用起来十分方便。</p><p><del>如果有公网 IP 或设置好内网穿透，就可以实现字面意义上的远程控制——只要延迟能忍的话。</del></p><p><strong>注意切不可在公网上开启！Android 漏洞极多，尤其是老旧版本，非常容易成为肉鸡！</strong></p><p>遗憾的是它只支持标准的 5555 端口，不能自定义，也不支持路径（反向代理）。</p><h3 id=时钟>时钟</h3><p>可能是我孤陋寡闻，Android APP 浩如烟海，我竟然找不到一款简洁好用的待机时钟。</p><p>目前用的这个名字就不说了，CPU 占用率高得离谱。</p><p>有空自己写一个。</p></article><section class="article labels"><a class=tag href=/tags/android/>Android</a><a class=tag href=/tags/linux/>Linux</a></section><section class="article license"><p xmlns:cc=http://creativecommons.org/ns# style=text-align:center>本作品根据 <a href=http://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank rel="license noopener noreferrer" style=display:inline-block>署名-非商业性使用-相同方式共享 4.0 国际许可<img style=height:15px!important;margin-left:1px;vertical-align:text-bottom src=/cc-icons/cc.svg><img style=height:15px!important;margin-left:1px;vertical-align:text-bottom src=/cc-icons/by.svg><img style=height:15px!important;margin-left:1px;vertical-align:text-bottom src=/cc-icons/nc.svg><img style=height:15px!important;margin-left:1px;vertical-align:text-bottom src=/cc-icons/sa.svg></a> 进行授权。</p></section></div><div class="article bottom"><section class="article navigation"><p><a class=link href=/posts/problems-with-homebrew/><span class="iconfont icon-article"></span>Homebrew 使用中的一些问题</a></p><p><a class=link href=/posts/transmission-block-leechers/><span class="iconfont icon-article"></span>Transmission 屏蔽迅雷等吸血客户端</a></p></section><section class="article discussion"><script>function loadComment(){let e=document.createElement("script");e.src="https://utteranc.es/client.js",e.setAttribute("repo","qianbinbin/qianbinbin.github.io"),e.setAttribute("issue-term","pathname"),e.setAttribute("theme","preferred-color-scheme"),e.setAttribute("crossorigin","anonymous"),e.setAttribute("async",""),document.querySelector("section.article.discussion").innerHTML="",document.querySelector("section.article.discussion").appendChild(e)}loadComment(),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{loadComment()})</script></section></div></section><section id=footer><div class=footer-wrap><p class=copyright>© 2017-2024 Binac.</p></div></section><script async src="https://www.googletagmanager.com/gtag/js?id=G-N7VZY53PLB"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-N7VZY53PLB")}</script><script src=https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js></script><script>addBackToTop({diameter:42})</script></body></html>