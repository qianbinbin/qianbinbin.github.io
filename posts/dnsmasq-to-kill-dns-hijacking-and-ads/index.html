<!doctype html><html lang=zh><meta charset=utf-8><meta name=generator content="Hugo 0.136.2"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light dark"><meta name=supported-color-schemes content="light dark"><link rel=icon href=/favicons/favicon.svg><title>Dnsmasq 去 DNS 污染和广告&nbsp;&ndash;&nbsp;Binac</title><link rel=stylesheet href=/css/core.min.d30edcc615d78b7f8a2a9e5f1b66bd074a7ad2e94b579fa5902d0967ce0f7684b300ef3a9e15d41af82c75f3fb951d4b.css integrity=sha384-0w7cxhXXi3+KKp5fG2a9B0p60ulLV5+lkC0JZ84PdoSzAO86nhXUGvgsdfP7lR1L><meta name=twitter:card content="summary">
<meta name=twitter:title content="Dnsmasq 去 DNS 污染和广告"><body><section id=header><div class="header wrap"><span class="header left-side"><a class="site home" href=/><img class="site logo" src=/favicons/favicon.svg alt><span class="site name">Binac</span></a></span>
<span class="header right-side"><div class="nav wrap"><nav class=nav><a class='nav item active' href=/posts/ title=文章>文章</a>
<a class='nav item' href=/nonsense/ title=妄言>妄言</a>
<a class='nav item' href=/tuya/ title=涂鸦>涂鸦</a>
<a class='nav item' href=/tags/ title>标签</a></nav></div></span></div></section><section id=content><div class=article-container><section class="article header"><h1 class="article title">Dnsmasq 去 DNS 污染和广告</h1><p class="article date">2021-09-21<span class=lastmod> • 更新于 2023-12-30</span></p></section><article class="article markdown-body"><p>有时网站被墙，可能只是域名被劫持了，IP 还是通的。ISP 会拦截 53 端口数据，看到某些域名就 angry，直接返回一个假 IP。</p><p>例如对某域名进行两次 OpenDNS 查询：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ dig +short example.com @208.67.222.222
</span></span><span class=line><span class=cl>$ dig +short example.com @208.67.222.222 -p <span class=m>5353</span>
</span></span></code></pre></div><p>第一次默认使用 53 端口，第二次使用非标准的 5353 端口。如果两次查询结果不一样，那么可能域名就被劫持了。这是因为 5353 端口暂时还没被屏蔽。</p><p>利用 Dnsmasq，除了可以使用非标准端口外，还能系统级屏蔽广告，岂不美哉？</p><p>另外还可以使用 DoH 或 DoT 加密方案，分别基于 HTTPS 和 TLS。</p><p>然而这两个方案缺乏系统级支持（据说 iOS 14、macOS 11、Windows 11 会支持？），而且 DoT 的 853 端口似乎已经被屏蔽了。不过 DoH 很有希望啊，毕竟总不能屏蔽标准 HTTPS 端口。</p><p>第三方 DoH 实现可以用 dnscrypt-proxy。</p><h2 id=dnsmasq>Dnsmasq</h2><h3 id=配置>配置</h3><p>安装 Dnsmasq，编辑配置文件 /etc/dnsmasq.conf（macOS 则为 /usr/local/etc/dnsmasq.conf），主要设置监听地址，以及上游 DNS & 端口：</p><pre tabindex=0><code>listen-address=127.0.0.1
# ustc
server=202.141.162.123#5353
server=202.141.178.13#5353
# opendns
server=208.67.222.222#5353
server=208.67.220.220#5353
</code></pre><p>这里使用了中科大的 DNS 用于境内网站查询，OpenDNS 用于境外网站查询。其他选项可以酌情配置。</p><blockquote><p>更新：科大 DNS 似乎不再提供校外服务。</p></blockquote><blockquote><p>2023 年 11 月，个人测试发现，清华 DNS 再次停止校外服务。</p><p>清华镜像到底是些什么人在维护，是不是脑子卷*了？给他们 contribute 的时候是一句谢谢也没有，没几个人的 issue，但凡有那么一丁点跑题就给 hide 掉，理由是 off-topic，我 off 你**。</p><p>这帮卷*是有点权力就一定要用出来才行，似乎不这样就体现不出和我们这些平头老百姓的区别，那能出孙铊就不奇怪了。</p></blockquote><p>然后把系统 DNS 设置为 <code>127.0.0.1</code> 即可。</p><p>需要注意的是，类 Unix 系统的 DNS 一般在 /etc/resolv.conf 中，但这个文件不应该直接修改，因为它是由某些网络服务维护的，直接配置可能不生效或丢失。</p><p>例如 macOS 应该在系统设置里修改。Debian 可以参考 <a href=https://wiki.debian.org/resolv.conf target=_blank rel="noopener noreferrer">resolv.conf - Debian Wiki</a>。</p><h3 id=去广告>去广告</h3><p>网上有不少现成的 Dnsmasq 去广告配置文件，例如 <code>https://anti-ad.net/anti-ad-for-dnsmasq.conf</code>，将文件放到 /etc/dnsmasq.d/（macOS 则为 /usr/local/etc/dnsmasq.d/）下重启服务即可。</p><p>这些配置文件会经常更新，可以用 cron 定时自动更新。</p><p>由于只是屏蔽域名，网页上仍然可能出现牛皮癣，而且有些广告并没有单独使用域名，因此 AdBlock 这类插件还是有必要的。</p><h2 id=doh>DoH</h2><p>要使用 dnscrypt-proxy，则应把 Dnsmasq 配置中的服务器转到 dnscrypt-proxy。个人没有这个需求，就不赘述了。</p></article><section class="article labels"><a class=tag href=/tags/dns/>DNS</a><a class=tag href=/tags/macos/>macOS</a><a class=tag href=/tags/linux/>Linux</a></section><section class="article license"><p xmlns:cc=http://creativecommons.org/ns# style=text-align:center>本作品根据 <a href=http://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank rel="license noopener noreferrer" style=display:inline-block>署名-非商业性使用-相同方式共享 4.0 国际许可<img style=height:15px!important;margin-left:1px;vertical-align:text-bottom src=/cc-icons/cc.svg><img style=height:15px!important;margin-left:1px;vertical-align:text-bottom src=/cc-icons/by.svg><img style=height:15px!important;margin-left:1px;vertical-align:text-bottom src=/cc-icons/nc.svg><img style=height:15px!important;margin-left:1px;vertical-align:text-bottom src=/cc-icons/sa.svg></a> 进行授权。</p></section></div><div class="article bottom"><section class="article navigation"><p><a class=link href=/posts/transmission-block-leechers/><span class="iconfont icon-article"></span>Transmission 屏蔽迅雷等吸血客户端</a></p><p><a class=link href=/posts/moebooru-crawler/><span class="iconfont icon-article"></span>Y 站、K 站下载器 moebooru-crawler</a></p></section><section class="article discussion"><script>function loadComment(){let e=document.createElement("script");e.src="https://utteranc.es/client.js",e.setAttribute("repo","qianbinbin/qianbinbin.github.io"),e.setAttribute("issue-term","pathname"),e.setAttribute("theme","preferred-color-scheme"),e.setAttribute("crossorigin","anonymous"),e.setAttribute("async",""),document.querySelector("section.article.discussion").innerHTML="",document.querySelector("section.article.discussion").appendChild(e)}loadComment(),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{loadComment()})</script></section></div></section><section id=footer><div class=footer-wrap><p class=copyright>© 2017-2024 Binac.</p></div></section><script async src="https://www.googletagmanager.com/gtag/js?id=G-N7VZY53PLB"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-N7VZY53PLB")}</script><script src=https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js></script><script>addBackToTop({diameter:42})</script></body></html>