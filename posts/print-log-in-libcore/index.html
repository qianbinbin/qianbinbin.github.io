<!doctype html><html lang=zh><meta charset=utf-8><meta name=generator content="Hugo 0.136.2"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light dark"><meta name=supported-color-schemes content="light dark"><link rel=icon href=/favicons/favicon.svg><title>在 Android Java 核心库 libcore 中打印 Log&nbsp;&ndash;&nbsp;Binac</title><link rel=stylesheet href=/css/core.min.d30edcc615d78b7f8a2a9e5f1b66bd074a7ad2e94b579fa5902d0967ce0f7684b300ef3a9e15d41af82c75f3fb951d4b.css integrity=sha384-0w7cxhXXi3+KKp5fG2a9B0p60ulLV5+lkC0JZ84PdoSzAO86nhXUGvgsdfP7lR1L><meta name=twitter:card content="summary">
<meta name=twitter:title content="在 Android Java 核心库 libcore 中打印 Log"><body><section id=header><div class="header wrap"><span class="header left-side"><a class="site home" href=/><img class="site logo" src=/favicons/favicon.svg alt><span class="site name">Binac</span></a></span>
<span class="header right-side"><div class="nav wrap"><nav class=nav><a class='nav item active' href=/posts/ title=文章>文章</a>
<a class='nav item' href=/nonsense/ title=妄言>妄言</a>
<a class='nav item' href=/tuya/ title=涂鸦>涂鸦</a>
<a class='nav item' href=/tags/ title>标签</a></nav></div></span></div></section><section id=content><div class=article-container><section class="article header"><h1 class="article title">在 Android Java 核心库 libcore 中打印 Log</h1><p class="article date">2017-08-30</p></section><article class="article markdown-body"><p>Android Java 核心库中是无法直接使用 android.util.Log 的，添加后编译不通过，因为 framework 中的 Java API 依赖于 Java 核心库。</p><p>在 Android 7.0 之前，Java 核心库源码在<code>libcore/luni/</code>下，luni 代表 lang、util、net、io，是 Java 中最常见的包；Android 7.0 中，核心库在<code>libcore/ojluni/</code>下，oj 代表 OpenJDK。</p><p>本文简单介绍在核心库中打印 Log 的几种方法。</p><h2 id=使用-systemout-和-systemerr>使用 System.out 和 System.err</h2><p>这是很常见的方法，在 Android 中它被重定向到本地的 Log 系统，tag 分别为<code>System.out</code>和<code>System.err</code>。</p><p>缺点在于，它不能自定义 tag，而且这种方法是在 SystemServer 进程创建之后、启动之前进行重定向的，在这之前无法打印 Log。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// frameworks/base/core/java/com/android/internal/os/RuntimeInit.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * The main function called when started through the zygote process. This
</span></span></span><span class=line><span class=cl><span class=cm> * could be unified with main(), if the native code in nativeFinishInit()
</span></span></span><span class=line><span class=cl><span class=cm> * were rationalized with Zygote startup.&lt;p&gt;
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * Current recognized args:
</span></span></span><span class=line><span class=cl><span class=cm> * &lt;ul&gt;
</span></span></span><span class=line><span class=cl><span class=cm> *   &lt;li&gt; &lt;code&gt; [--] &amp;lt;start class name&amp;gt;  &amp;lt;args&amp;gt;
</span></span></span><span class=line><span class=cl><span class=cm> * &lt;/ul&gt;
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @param targetSdkVersion target SDK version
</span></span></span><span class=line><span class=cl><span class=cm> * @param argv arg strings
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>zygoteInit</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>targetSdkVersion</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>argv</span><span class=p>,</span><span class=w> </span><span class=n>ClassLoader</span><span class=w> </span><span class=n>classLoader</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>throws</span><span class=w> </span><span class=n>ZygoteInit</span><span class=p>.</span><span class=na>MethodAndArgsCaller</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG</span><span class=p>)</span><span class=w> </span><span class=n>Slog</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;RuntimeInit: Starting application from zygote&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Trace</span><span class=p>.</span><span class=na>traceBegin</span><span class=p>(</span><span class=n>Trace</span><span class=p>.</span><span class=na>TRACE_TAG_ACTIVITY_MANAGER</span><span class=p>,</span><span class=w> </span><span class=s>&#34;RuntimeInit&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>redirectLogStreams</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>commonInit</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>nativeZygoteInit</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>applicationInit</span><span class=p>(</span><span class=n>targetSdkVersion</span><span class=p>,</span><span class=w> </span><span class=n>argv</span><span class=p>,</span><span class=w> </span><span class=n>classLoader</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Redirect System.out and System.err to the Android log.
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>redirectLogStreams</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>setOut</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>AndroidPrintStream</span><span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>INFO</span><span class=p>,</span><span class=w> </span><span class=s>&#34;System.out&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>err</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>setErr</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>AndroidPrintStream</span><span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>WARN</span><span class=p>,</span><span class=w> </span><span class=s>&#34;System.err&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>在<code>RuntimeInit.zygoteInit()</code>方法中，调用<code>redirectLogStreams()</code>方法，设置输出流为 AndroidPrintStream，当使用<code>System.out</code>和<code>System.err</code>进行打印时，最终是调用的是 android.util.Log：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// frameworks/base/core/java/com/android/internal/os/AndroidPrintStream.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Print stream which log lines using Android&#39;s logging system.
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * {@hide}
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>AndroidPrintStream</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>LoggingPrintStream</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>priority</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>tag</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Constructs a new logging print stream.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param priority from {@link android.util.Log}
</span></span></span><span class=line><span class=cl><span class=cm>     * @param tag to log
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>AndroidPrintStream</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>priority</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>tag</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tag</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NullPointerException</span><span class=p>(</span><span class=s>&#34;tag&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>priority</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>priority</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>tag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tag</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>log</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>line</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Log</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>priority</span><span class=p>,</span><span class=w> </span><span class=n>tag</span><span class=p>,</span><span class=w> </span><span class=n>line</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=使用-javautillogginglogger>使用 java.util.logging.Logger</h3><p>Java 核心库中有 java.util.logging.Logger，在 Android 中它也被重定向到 Android 本地的 Log 系统。</p><p>使用方法很简单，在需要打印 Log 的源码中添加：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Logger</span><span class=w> </span><span class=n>sLogger</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Logger</span><span class=p>.</span><span class=na>getLogger</span><span class=p>(</span><span class=s>&#34;MyTag&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>logi</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>msg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sLogger</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=n>msg</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>使用时只需调用<code>logi()</code>方法即可。</p><p>这里使用的是 Level 为 INFO 的 Log。你也可以自定义 Level，核心库 java.util.logging.Logger 与 Android 本地 android.util.Log 的 Level 对应关系，可以参考 java.util.logging.Level 和 com.android.internal.logging.AndroidHandler。</p><p>Logger 的重定向位置和<code>System.out</code>接近，在这之前也无法打印 Log。</p><p>事实上，这里 Log 实际上是调用了 Logger 中注册的 Handler（java.util.logging.Handler，不是 android.os.Handler）。</p><p>Handler 的注册，紧随<code>RuntimeInit.zygoteInit()</code>方法中<code>redirectLogStreams()</code>后，调用<code>commonInit()</code>方法：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// frameworks/base/core/java/com/android/internal/os/RuntimeInit.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>commonInit</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>     * Sets handler for java.util.logging to use Android log facilities.
</span></span></span><span class=line><span class=cl><span class=cm>     * The odd &#34;new instance-and-then-throw-away&#34; is a mirror of how
</span></span></span><span class=line><span class=cl><span class=cm>     * the &#34;java.util.logging.config.class&#34; system property works. We
</span></span></span><span class=line><span class=cl><span class=cm>     * can&#39;t use the system property here since the logger has almost
</span></span></span><span class=line><span class=cl><span class=cm>     * certainly already been initialized.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>LogManager</span><span class=p>.</span><span class=na>getLogManager</span><span class=p>().</span><span class=na>reset</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>AndroidConfig</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>这里实例化了 AndroidConfig 然后丢弃。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// frameworks/base/core/java/com/android/internal/logging/AndroidConfig.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Implements the java.util.logging configuration for Android. Activates a log
</span></span></span><span class=line><span class=cl><span class=cm> * handler that writes to the Android log.
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>AndroidConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * This looks a bit weird, but it&#39;s the way the logging config works: A
</span></span></span><span class=line><span class=cl><span class=cm>     * named class is instantiated, the constructor is assumed to tweak the
</span></span></span><span class=line><span class=cl><span class=cm>     * configuration, the instance itself is of no interest.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>AndroidConfig</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Logger</span><span class=w> </span><span class=n>rootLogger</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Logger</span><span class=p>.</span><span class=na>getLogger</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>rootLogger</span><span class=p>.</span><span class=na>addHandler</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>AndroidHandler</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>rootLogger</span><span class=p>.</span><span class=na>setLevel</span><span class=p>(</span><span class=n>Level</span><span class=p>.</span><span class=na>INFO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Turn down logging in Apache libraries.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Logger</span><span class=p>.</span><span class=na>getLogger</span><span class=p>(</span><span class=s>&#34;org.apache&#34;</span><span class=p>).</span><span class=na>setLevel</span><span class=p>(</span><span class=n>Level</span><span class=p>.</span><span class=na>WARNING</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ex</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>实例化过程中注册了 AndroidHandler。</p><p>当使用 Logger 打印 Log 时，最终调用的是<code>Logger#log(LogRecord)</code>方法：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// libcore/ojluni/src/main/java/java/util/logging/Logger.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>log</span><span class=p>(</span><span class=n>LogRecord</span><span class=w> </span><span class=n>record</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Logger</span><span class=w> </span><span class=n>logger</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>logger</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Handler</span><span class=w> </span><span class=n>handler</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>logger</span><span class=p>.</span><span class=na>getHandlers</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>handler</span><span class=p>.</span><span class=na>publish</span><span class=p>(</span><span class=n>record</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>logger</span><span class=p>.</span><span class=na>getUseParentHandlers</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>logger</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>logger</span><span class=p>.</span><span class=na>getParent</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>对已经注册的 Handler 回调其<code>publish()</code>方法：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// frameworks/base/core/java/com/android/internal/logging/AndroidHandler.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>publish</span><span class=p>(</span><span class=n>Logger</span><span class=w> </span><span class=n>source</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>tag</span><span class=p>,</span><span class=w> </span><span class=n>Level</span><span class=w> </span><span class=n>level</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// TODO: avoid ducking into native 2x; we aren&#39;t saving any formatter calls</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>priority</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getAndroidLevel</span><span class=p>(</span><span class=n>level</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>tag</span><span class=p>,</span><span class=w> </span><span class=n>priority</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Log</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>priority</span><span class=p>,</span><span class=w> </span><span class=n>tag</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RuntimeException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Log</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=s>&#34;AndroidHandler&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Error logging message.&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>可见最终还是调用的 android.util.Log。</p><p>如果需要在开机流程中较早的位置打印 Log，则此方法同样无效。</p><h2 id=移植-androidutillog>移植 android.util.Log</h2><p>以上方法使用简单，可以满足大部分需要，但都有一些缺陷。其实也可以把 android.util.Log 核心部分移植过来，只不过有些繁琐，需要以 JNI 方式调用 liblog 中的 Log 函数。</p><p>例如，要使<code>java.util.logging.Logger</code>也能像<code>android.util.Log</code>那样方便地打印 Log，可以在 Logger 类中添加一个静态方法<code>d()</code>，对应<code>android.util.Log.d()</code>。</p><h3 id=在-java-代码中声明-native-方法>在 Java 代码中声明 native 方法</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// libcore/ojluni/src/main/java/java/util/logging/Logger.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @hide
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>d</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>tag</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>msg</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>println_native</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>3</span><span class=p>,</span><span class=w> </span><span class=n>tag</span><span class=p>,</span><span class=w> </span><span class=n>msg</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @hide
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>native</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>println_native</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>bufID</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>priority</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>tag</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>msg</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>注意要使用<code>hide</code>修饰。</p><p>然后在需要的地方调用<code>Logger.d()</code>方法。</p><p>编译生成 core-oj.jar，把它 push 到 /system/framework/ 中。要使此核心库生效，可能需要删除 /system/framework/arm/ 或 /system/framework/arm64/ 下的 boot.art、boot.oat（取决于手机，可都删除，删除后重启会比较慢）。</p><h3 id=实现-jni-层>实现 JNI 层</h3><p>只要移植 android_util_Log.cpp 中的<code>android_util_Log_println_native()</code>方法即可，创建文件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// libcore/ojluni/src/main/native/java_util_logging_Logger.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;jni.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;JNIHelp.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;cutils/log.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define NATIVE_METHOD(className, functionName, signature) \
</span></span></span><span class=line><span class=cl><span class=cp>{ #functionName, signature, (void*)(className ## _ ## functionName) }
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/*******************************************************************/</span>
</span></span><span class=line><span class=cl><span class=cm>/*  BEGIN JNI ********* BEGIN JNI *********** BEGIN JNI ************/</span>
</span></span><span class=line><span class=cl><span class=cm>/*******************************************************************/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=n>jint</span> <span class=nf>Logger_println_native</span><span class=p>(</span><span class=n>JNIEnv</span><span class=o>*</span> <span class=n>env</span><span class=p>,</span> <span class=n>jobject</span> <span class=n>clazz</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>jint</span> <span class=n>bufID</span><span class=p>,</span> <span class=n>jint</span> <span class=n>priority</span><span class=p>,</span> <span class=n>jstring</span> <span class=n>tagObj</span><span class=p>,</span> <span class=n>jstring</span> <span class=n>msgObj</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>tag</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>msg</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>msgObj</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>jniThrowNullPointerException</span><span class=p>(</span><span class=n>env</span><span class=p>,</span> <span class=s>&#34;println needs a message&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>bufID</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=o>||</span> <span class=n>bufID</span> <span class=o>&gt;=</span> <span class=n>LOG_ID_MAX</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>jniThrowNullPointerException</span><span class=p>(</span><span class=n>env</span><span class=p>,</span> <span class=s>&#34;bad bufID&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>tagObj</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>tag</span> <span class=o>=</span> <span class=n>env</span><span class=o>-&gt;</span><span class=n>GetStringUTFChars</span><span class=p>(</span><span class=n>tagObj</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>msg</span> <span class=o>=</span> <span class=n>env</span><span class=o>-&gt;</span><span class=n>GetStringUTFChars</span><span class=p>(</span><span class=n>msgObj</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>res</span> <span class=o>=</span> <span class=n>__android_log_buf_write</span><span class=p>(</span><span class=n>bufID</span><span class=p>,</span> <span class=p>(</span><span class=n>android_LogPriority</span><span class=p>)</span><span class=n>priority</span><span class=p>,</span> <span class=n>tag</span><span class=p>,</span> <span class=n>msg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>tag</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>env</span><span class=o>-&gt;</span><span class=n>ReleaseStringUTFChars</span><span class=p>(</span><span class=n>tagObj</span><span class=p>,</span> <span class=n>tag</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>env</span><span class=o>-&gt;</span><span class=n>ReleaseStringUTFChars</span><span class=p>(</span><span class=n>msgObj</span><span class=p>,</span> <span class=n>msg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>res</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=n>JNINativeMethod</span> <span class=n>gMethods</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>NATIVE_METHOD</span><span class=p>(</span><span class=n>Logger</span><span class=p>,</span> <span class=n>println_native</span><span class=p>,</span> <span class=s>&#34;(IILjava/lang/String;Ljava/lang/String;)I&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>register_java_util_logging_Logger</span><span class=p>(</span><span class=n>JNIEnv</span><span class=o>*</span> <span class=n>env</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>jniRegisterNativeMethods</span><span class=p>(</span><span class=n>env</span><span class=p>,</span> <span class=s>&#34;java/util/logging/Logger&#34;</span><span class=p>,</span> <span class=n>gMethods</span><span class=p>,</span> <span class=n>NELEM</span><span class=p>(</span><span class=n>gMethods</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>在 Regisger.cpp 中注册：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// libcore/ojluni/src/main/native/Register.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=k>extern</span> <span class=kt>void</span> <span class=nf>register_java_util_logging_Logger</span><span class=p>(</span><span class=n>JNIEnv</span><span class=o>*</span> <span class=n>env</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=n>jint</span> <span class=nf>JNI_OnLoad</span><span class=p>(</span><span class=n>JavaVM</span><span class=o>*</span> <span class=n>vm</span><span class=p>,</span> <span class=kt>void</span><span class=o>*</span><span class=p>)</span> <span class=p>{</span> <span class=n>JNIEnv</span><span class=o>*</span> <span class=n>env</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=n>register_java_util_logging_Logger</span><span class=p>(</span><span class=n>env</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><p>接着在 libcore/ojluni/src/main/native/openjdksub.mk 中添加相应的 C++ 文件。</p><p>编译生成 libopenjdk.so，把它 push 到 /system/lib/ 或 /system/lib64/ 下（取决于手机），然后重启即可打印出我们想要的 Log 了。</p><p>但我在<code>java.io.File#delete()</code>中使用这个 Log 时，发现了一个奇怪的问题：一些第三方 APP 会报 java.lang.UnsatisfiedLinkError 错误（如 Chrome 等），而 Android 系统本身，以及其它 APP，包括自己写的 demo 都没有问题，尝试网上各种方法无果，希望有人能指点迷津……</p><h2 id=打印栈信息-stack-trace>打印栈信息 Stack Trace</h2><p>同样我们可以把 android.util.Log 中的<code>getStackTraceString()</code>方法移植过来。</p><p>需要注意的是，FastPrintWriter 也是 framework 中的，这里可以替换为 Java 核心库中的 PrintWriter。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @hide
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>getStackTraceString</span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>tr</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tr</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// This is to reduce the amount of log spew that apps do in the non-error</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// condition of the network being unavailable.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Throwable</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tr</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>t</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>t</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>UnknownHostException</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=na>getCause</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>StringWriter</span><span class=w> </span><span class=n>sw</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StringWriter</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// PrintWriter pw = new FastPrintWriter(sw, false, 256);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PrintWriter</span><span class=w> </span><span class=n>pw</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>PrintWriter</span><span class=p>(</span><span class=n>sw</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>tr</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>(</span><span class=n>pw</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>pw</span><span class=p>.</span><span class=na>flush</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>sw</span><span class=p>.</span><span class=na>toString</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>使用<code>getStackTraceString(new Throwable())</code>即可得到栈信息了。</p></article><section class="article labels"><a class=tag href=/tags/android/>Android</a><a class=tag href=/tags/java/>Java</a><a class=tag href=/tags/jni/>JNI</a></section><section class="article license"><p xmlns:cc=http://creativecommons.org/ns# style=text-align:center>本作品根据 <a href=http://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank rel="license noopener noreferrer" style=display:inline-block>署名-非商业性使用-相同方式共享 4.0 国际许可<img style=height:15px!important;margin-left:1px;vertical-align:text-bottom src=/cc-icons/cc.svg><img style=height:15px!important;margin-left:1px;vertical-align:text-bottom src=/cc-icons/by.svg><img style=height:15px!important;margin-left:1px;vertical-align:text-bottom src=/cc-icons/nc.svg><img style=height:15px!important;margin-left:1px;vertical-align:text-bottom src=/cc-icons/sa.svg></a> 进行授权。</p></section></div><div class="article bottom"><section class="article navigation"><p><a class=link href=/posts/factory-pattern/><span class="iconfont icon-article"></span>工厂模式 Factory Pattern</a></p><p><a class=link href=/posts/median-of-two-sorted-arrays/><span class="iconfont icon-article"></span>求两个有序数组的中位数 Median of Two Sorted Arrays</a></p></section><section class="article discussion"><script>function loadComment(){let e=document.createElement("script");e.src="https://utteranc.es/client.js",e.setAttribute("repo","qianbinbin/qianbinbin.github.io"),e.setAttribute("issue-term","pathname"),e.setAttribute("theme","preferred-color-scheme"),e.setAttribute("crossorigin","anonymous"),e.setAttribute("async",""),document.querySelector("section.article.discussion").innerHTML="",document.querySelector("section.article.discussion").appendChild(e)}loadComment(),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{loadComment()})</script></section></div></section><section id=footer><div class=footer-wrap><p class=copyright>© 2017-2024 Binac.</p></div></section><script async src="https://www.googletagmanager.com/gtag/js?id=G-N7VZY53PLB"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-N7VZY53PLB")}</script><script src=https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js></script><script>addBackToTop({diameter:42})</script></body></html>