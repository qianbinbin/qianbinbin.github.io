<!doctype html><html lang=zh><meta charset=utf-8><meta name=generator content="Hugo 0.136.2"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light dark"><meta name=supported-color-schemes content="light dark"><link rel=icon href=/favicons/favicon.svg><title>代理模式 Proxy Pattern&nbsp;&ndash;&nbsp;Binac</title><link rel=stylesheet href=/css/core.min.d30edcc615d78b7f8a2a9e5f1b66bd074a7ad2e94b579fa5902d0967ce0f7684b300ef3a9e15d41af82c75f3fb951d4b.css integrity=sha384-0w7cxhXXi3+KKp5fG2a9B0p60ulLV5+lkC0JZ84PdoSzAO86nhXUGvgsdfP7lR1L><meta name=twitter:card content="summary">
<meta name=twitter:title content="代理模式 Proxy Pattern"><body><section id=header><div class="header wrap"><span class="header left-side"><a class="site home" href=/><img class="site logo" src=/favicons/favicon.svg alt><span class="site name">Binac</span></a></span>
<span class="header right-side"><div class="nav wrap"><nav class=nav><a class='nav item active' href=/posts/ title=文章>文章</a>
<a class='nav item' href=/nonsense/ title=妄言>妄言</a>
<a class='nav item' href=/tuya/ title=涂鸦>涂鸦</a>
<a class='nav item' href=/tags/ title>标签</a></nav></div></span></div></section><section id=content><div class=article-container><section class="article header"><h1 class="article title">代理模式 Proxy Pattern</h1><p class="article date">2020-03-10</p></section><article class="article markdown-body"><p>客户端不能或不想直接使用一个类时，用代理模式可以实现间接使用。</p><p>代理模式一般指的是静态代理，即在编译时实现，代理类 SubjectProxy 与被代理的真实类 RealSubject 实现同一个 Subject 接口，SubjectProxy 维护一个 RealSubject 实例，客户端通过 SubjectProxy 来间接使用 RealSubject。</p><p>Java 可以实现动态代理，在运行时定制或增强功能。</p><h2 id=实例>实例</h2><h3 id=静态代理>静态代理</h3><p><img src=/images/proxy-pattern/proxy-pattern.png alt></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>Subject</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>request</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>RealSubject</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Subject</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>request</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Throwable</span><span class=p>().</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SubjectProxy</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Subject</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>RealSubject</span><span class=w> </span><span class=n>mSubject</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>request</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mSubject</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mSubject</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RealSubject</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mSubject</span><span class=p>.</span><span class=na>request</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h4 id=测试>测试</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Subject</span><span class=w> </span><span class=n>subject</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SubjectProxy</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>subject</span><span class=p>.</span><span class=na>request</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>java.lang.Throwable
</span></span><span class=line><span class=cl>	at io.binac.designpattern.proxy.RealSubject.request<span class=o>(</span>RealSubject.java:6<span class=o>)</span>
</span></span><span class=line><span class=cl>	at io.binac.designpattern.proxy.SubjectProxy.request<span class=o>(</span>SubjectProxy.java:10<span class=o>)</span>
</span></span></code></pre></div><h4 id=与装饰器模式比较>与装饰器模式比较</h4><p>两者都封装原始对象，代理模式注重控制对象的访问，装饰器模式则注重装饰对象，而且可以多次装饰。</p><h4 id=应用>应用</h4><ul><li><p>远程代理
为对象在不同地址空间提供局部代表，通过序列化等手段，使客户端的代码在远程执行</p></li><li><p>虚拟代理
根据需要创建开销很大的对象，直到真正需要一个对象时才创建它，创建完成前用虚拟代理来代替，例如加载网络图片前，先加载本地图片</p></li><li><p>保护代理
控制对原始对象的访问</p></li><li><p>指针引用
当调用真实的对象时，代理处理一些额外工作，例如引用计数，当该对象没有引用时自动释放</p></li></ul><h3 id=java-动态代理>Java 动态代理</h3><p>在动态代理中，代理类的字节码将在运行时生成并载入当前代理的 <code>ClassLoader</code>。这里介绍 Java 自身支持的代理方式，此外还有 cglib 等第三方库。</p><p>实现 <code>java.lang.reflect.InvocationHandler</code> 接口：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SubjectInvocationHandler</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>InvocationHandler</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>RealSubject</span><span class=w> </span><span class=n>mSubject</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>SubjectInvocationHandler</span><span class=p>(</span><span class=n>RealSubject</span><span class=w> </span><span class=n>subject</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mSubject</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>subject</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>invoke</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>proxy</span><span class=p>,</span><span class=w> </span><span class=n>Method</span><span class=w> </span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Throwable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;invoking &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>method</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>method</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=n>mSubject</span><span class=p>,</span><span class=w> </span><span class=n>args</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;invoked &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>method</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>动态代理是通过反射完成的，在重写 <code>InvocationHandler#invoke</code> 时定制所需的方法，不需要像静态代理那样重载被代理接口的全部方法。</p><h4 id=测试-1>测试</h4><p>先获取一个需要代理的实例，然后通过 <code>java.lang.reflect.Proxy#newProxyInstance</code> 来获取代理类的对象：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Subject</span><span class=w> </span><span class=n>subject</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RealSubject</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Subject</span><span class=w> </span><span class=n>proxy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Subject</span><span class=p>)</span><span class=w> </span><span class=n>Proxy</span><span class=p>.</span><span class=na>newProxyInstance</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>subject</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getClassLoader</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>subject</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getInterfaces</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>SubjectInvocationHandler</span><span class=p>(</span><span class=n>subject</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>proxy</span><span class=p>.</span><span class=na>request</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>invoking public abstract void io.binac.designpattern.proxy.Subject.request<span class=o>()</span>
</span></span><span class=line><span class=cl>java.lang.Throwable
</span></span><span class=line><span class=cl>	at io.binac.designpattern.proxy.RealSubject.request<span class=o>(</span>RealSubject.java:6<span class=o>)</span>
</span></span><span class=line><span class=cl>	at sun.reflect.NativeMethodAccessorImpl.invoke0<span class=o>(</span>Native Method<span class=o>)</span>
</span></span><span class=line><span class=cl>	at sun.reflect.NativeMethodAccessorImpl.invoke<span class=o>(</span>NativeMethodAccessorImpl.java:62<span class=o>)</span>
</span></span><span class=line><span class=cl>	at sun.reflect.DelegatingMethodAccessorImpl.invoke<span class=o>(</span>DelegatingMethodAccessorImpl.java:43<span class=o>)</span>
</span></span><span class=line><span class=cl>	at java.lang.reflect.Method.invoke<span class=o>(</span>Method.java:498<span class=o>)</span>
</span></span><span class=line><span class=cl>	at io.binac.designpattern.proxy.SubjectInvocationHandler.invoke<span class=o>(</span>SubjectInvocationHandler.java:16<span class=o>)</span>
</span></span><span class=line><span class=cl>	at com.sun.proxy.<span class=nv>$Proxy9</span>.request<span class=o>(</span>Unknown Source<span class=o>)</span>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>invoked public abstract void io.binac.designpattern.proxy.Subject.request<span class=o>()</span>
</span></span></code></pre></div><p>需要注意的是，动态代理的类必须实现接口，使用时也要用接口的方式定义，这是因为生成的代理类继承了 <code>java.lang.reflect.Proxy</code>，而 Java 不支持多继承，只能用接口完成。如果手动生成字节码文件，可以看到定义类似这样：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>$Proxy0</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Proxy</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Subject</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=源码实现>源码实现</h2><p><a href=https://github.com/qianbinbin/DesignPattern/tree/master/src/main/java/io/binac/designpattern/proxy target=_blank rel="noopener noreferrer">https://github.com/qianbinbin/DesignPattern/tree/master/src/main/java/io/binac/designpattern/proxy</a></p><h2 id=参考资料>参考资料</h2><ol><li>《Head First 设计模式》</li><li><a href=https://www.ibm.com/developerworks/cn/java/j-lo-proxy-pattern/index.html target=_blank rel="noopener noreferrer">代理模式原理及实例讲解</a></li><li><a href=https://juejin.im/post/5d8a0799f265da5b7a752e7c target=_blank rel="noopener noreferrer">为什么JDK的动态代理要基于接口实现而不能基于继承实现？ - 掘金</a></li></ol></article><section class="article labels"><a class=tag href=/tags/java/>Java</a><a class=tag href=/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/>设计模式</a></section><section class="article license"><p xmlns:cc=http://creativecommons.org/ns# style=text-align:center>本作品根据 <a href=http://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank rel="license noopener noreferrer" style=display:inline-block>署名-非商业性使用-相同方式共享 4.0 国际许可<img style=height:15px!important;margin-left:1px;vertical-align:text-bottom src=/cc-icons/cc.svg><img style=height:15px!important;margin-left:1px;vertical-align:text-bottom src=/cc-icons/by.svg><img style=height:15px!important;margin-left:1px;vertical-align:text-bottom src=/cc-icons/nc.svg><img style=height:15px!important;margin-left:1px;vertical-align:text-bottom src=/cc-icons/sa.svg></a> 进行授权。</p></section></div><div class="article bottom"><section class="article navigation"><p><a class=link href=/posts/command-pattern/><span class="iconfont icon-article"></span>命令模式 Command Pattern</a></p><p><a class=link href=/posts/flyweight-pattern/><span class="iconfont icon-article"></span>享元模式 Flyweight Pattern</a></p></section><section class="article discussion"><script>function loadComment(){let e=document.createElement("script");e.src="https://utteranc.es/client.js",e.setAttribute("repo","qianbinbin/qianbinbin.github.io"),e.setAttribute("issue-term","pathname"),e.setAttribute("theme","preferred-color-scheme"),e.setAttribute("crossorigin","anonymous"),e.setAttribute("async",""),document.querySelector("section.article.discussion").innerHTML="",document.querySelector("section.article.discussion").appendChild(e)}loadComment(),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{loadComment()})</script></section></div></section><section id=footer><div class=footer-wrap><p class=copyright>© 2017-2024 Binac.</p></div></section><script async src="https://www.googletagmanager.com/gtag/js?id=G-N7VZY53PLB"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-N7VZY53PLB")}</script><script src=https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js></script><script>addBackToTop({diameter:42})</script></body></html>