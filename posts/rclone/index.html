<!doctype html><html lang=zh><meta charset=utf-8><meta name=generator content="Hugo 0.136.2"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light dark"><meta name=supported-color-schemes content="light dark"><link rel=icon href=/favicons/favicon.svg><title>使用 Rclone 挂载网盘&nbsp;&ndash;&nbsp;Binac</title><link rel=stylesheet href=/css/core.min.d30edcc615d78b7f8a2a9e5f1b66bd074a7ad2e94b579fa5902d0967ce0f7684b300ef3a9e15d41af82c75f3fb951d4b.css integrity=sha384-0w7cxhXXi3+KKp5fG2a9B0p60ulLV5+lkC0JZ84PdoSzAO86nhXUGvgsdfP7lR1L><meta name=twitter:card content="summary">
<meta name=twitter:title content="使用 Rclone 挂载网盘"><body><section id=header><div class="header wrap"><span class="header left-side"><a class="site home" href=/><img class="site logo" src=/favicons/favicon.svg alt><span class="site name">Binac</span></a></span>
<span class="header right-side"><div class="nav wrap"><nav class=nav><a class='nav item active' href=/posts/ title=文章>文章</a>
<a class='nav item' href=/nonsense/ title=妄言>妄言</a>
<a class='nav item' href=/tuya/ title=涂鸦>涂鸦</a>
<a class='nav item' href=/tags/ title>标签</a></nav></div></span></div></section><section id=content><div class=article-container><section class="article header"><h1 class="article title">使用 Rclone 挂载网盘</h1><p class="article date">2020-02-01<span class=lastmod> • 更新于 2023-09-27</span></p></section><article class="article markdown-body"><p>在没有图形界面的服务器上，或不想使用客户端软件时，如何方便地使用网盘是个问题。</p><p>Rclone 就是为此而生的，它可以方便在命令行下挂载网盘，目前已经支持包括 Google Drive、OneDrive 在内的几十个网盘，而且除了速度慢一点外，可以模拟本地磁盘，对于容量有限的 VPS 来说就是免费扩容，配合 aria2、Transmission 等工具，就可以打造离线下载服务器。</p><p>配合 <a href=https://github.com/messense/aliyundrive-webdav target=_blank rel="noopener noreferrer">aliyundrive-webdav</a> 项目，可以以 WebDAV 方式挂载阿里云盘。阿里云盘国内速度很不错，但国外就不太理想了，适合用作本地服务器备份、在线播放电影等。支持上传文件，但受限于 WebDAV 协议不支持文件秒传。</p><h2 id=安装>安装</h2><p>Debian 的官方源中 Rclone 版本过于陈旧，建议到官网下载：<a href=https://rclone.org/downloads/ target=_blank rel="noopener noreferrer">https://rclone.org/downloads/</a></p><p>或者脚本一键安装：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ curl https://rclone.org/install.sh <span class=p>|</span> sudo bash
</span></span></code></pre></div><h2 id=阿里云盘2023-更新>阿里云盘（2023 更新）</h2><p>以下以 Debian 为例，运行阿里云盘 WebDAV 服务并使用 Rclone 自动挂载。</p><h3 id=aliyundrive-webdav>aliyundrive-webdav</h3><p>首先安装 aliyundrive-webdav：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># pip install aliyundrive-webdav</span>
</span></span></code></pre></div><p>我讨厌虚拟环境，因为它总是把东西封装得面目全非，所以这里用特权用户安装，而且方便之后编写 systemd 脚本。根据个人喜好即可。</p><p>获取 token：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># aliyundrive-webdav qr login</span>
</span></span></code></pre></div><p>手机打开阿里云盘 APP 扫码得到 token。</p><p>为 WebDAV 服务专门建立一个目录，用于存放 token：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># mkdir /var/lib/private/aliyundrive-webdav</span>
</span></span><span class=line><span class=cl><span class=c1># vim /var/lib/private/aliyundrive-webdav/refresh_token</span>
</span></span></code></pre></div><p>将 token 复制到 refresh_token 文件中。</p><p>新建 systemd 脚本：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># cat /etc/systemd/system/aliyundrive-webdav.service</span>
</span></span><span class=line><span class=cl><span class=o>[</span>Unit<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>Description</span><span class=o>=</span>Aliyun Drive WebDAV Service
</span></span><span class=line><span class=cl><span class=nv>After</span><span class=o>=</span>network-online.target
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>Service<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>DynamicUser</span><span class=o>=</span>yes
</span></span><span class=line><span class=cl><span class=nv>StateDirectory</span><span class=o>=</span>aliyundrive-webdav
</span></span><span class=line><span class=cl><span class=nv>ExecStart</span><span class=o>=</span>/usr/local/bin/aliyundrive-webdav --host localhost --workdir <span class=s2>&#34;</span><span class=nv>$STATE_DIRECTORY</span><span class=s2>&#34;</span> --cache-ttl <span class=m>10</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>Install<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>WantedBy</span><span class=o>=</span>multi-user.target
</span></span></code></pre></div><p><code>/var/lib/private</code> 是个特殊的目录。</p><p>systemd 脚本如果指定了 <code>StateDirectory</code>，就会从 <code>/var/lib</code> 寻找目标文件夹，通过 <code>$STATE_DIRECTORY</code> 来访问它。但如果同时指定了 <code>DynamicUser=yes</code>，就会在 <code>/var/lib</code> 建立一个软链接指向 <code>/var/lib/private</code> 中的同名目标文件夹：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># ll /var/lib/aliyundrive-webdav</span>
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root <span class=m>26</span> Mar <span class=m>21</span> 16:48 /var/lib/aliyundrive-webdav -&gt; private/aliyundrive-webdav
</span></span></code></pre></div><p>由于只有特权用户能访问 <code>/var/lib/private</code>，以此保证了安全性，这就是上面建立 <code>/var/lib/private/aliyundrive-webdav</code> 目录的原因。</p><p>aliyundrive-webdav 通过 <code>--workdir</code> 参数指定工作目录，就可以读取和更新 token 了。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># systemctl daemon-reload</span>
</span></span><span class=line><span class=cl><span class=c1># systemctl start aliyundrive-webdav.service</span>
</span></span><span class=line><span class=cl><span class=c1># systemctl enable aliyundrive-webdav.service</span>
</span></span><span class=line><span class=cl><span class=c1># systemctl status aliyundrive-webdav.service</span>
</span></span></code></pre></div><h3 id=etcfstab-自动挂载>/etc/fstab 自动挂载</h3><p><a href=https://rclone.org/commands/rclone_mount/#rclone-as-unix-mount-helper target=_blank rel="noopener noreferrer">Rclone 可以作为 Unix mount helper</a> 实现 mount 命令的挂载：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># ln -s /usr/bin/rclone /sbin/mount.rclone</span>
</span></span></code></pre></div><p>还可以添加到 <code>/etc/fstab</code> 中，这就很方便了，不需要写什么蛋疼的 systemd 脚本。</p><p>不过这一方法需要 fuse3（<del><code>rclone mount</code> 似乎 fuse2 就行</del> 新版 <code>rclone mount</code> 也需要 fuse3 了）：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># apt install fuse3</span>
</span></span><span class=line><span class=cl><span class=c1># vim /etc/fuse.conf</span>
</span></span></code></pre></div><p>取消注释 <code>user_allow_other</code>，以允许其他用户访问挂载目录。</p><p>添加挂载项：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># mkdir /mnt/aliyun</span>
</span></span><span class=line><span class=cl><span class=c1># cat &lt;&lt;-END &gt;&gt;/etc/fstab</span>
</span></span><span class=line><span class=cl><span class=c1># https://rclone.org/commands/rclone_mount/#rclone-as-unix-mount-helper</span>
</span></span><span class=line><span class=cl>:webdav: /mnt/aliyun rclone nofail,_netdev,args2env,webdav_url<span class=o>=</span>http://localhost:8080,allow_other,vfs_cache_mode<span class=o>=</span>full,vfs_cache_max_age<span class=o>=</span>24h,cache_dir<span class=o>=</span>/var/cache/rclone,config<span class=o>=</span>/dev/null <span class=m>0</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>END
</span></span></code></pre></div><p>第四列是关注的重点，各选项以 <code>,</code> 分隔，例如，需要以指定用户挂载，可以添加 <code>uid=xxx,gid=xxx</code> 选项。</p><blockquote><p>注：</p><p>Debian 从最近（2023 年 9 月前后）某次更新后，原本第四列的 <code>x-systemd.automount</code> 将会导致 <code>Fatal error: mount not ready</code>，如果此时访问目录则会报错 <code>Transport endpoint is not connected</code>，原因不明，因此删去这个选项。</p><p>这个选项的作用是让目录在实际访问时挂载（延迟挂载），而不是开机就立即启动。</p></blockquote><p>如果有其它需要的 rclone 参数也可以添加，但 GNU 风格的参数要手动翻译一下，前缀 <code>--</code> 去掉，<code>-</code> 改为 <code>_</code>，例如 <code>--vfs-cache-mode=full</code> 要改为 <code>vfs_cache_mode=full</code>。</p><p>看看成功了没有：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># mount -av</span>
</span></span></code></pre></div><p>需要 debug 的话，在第四列添加 <code>vv</code> 以查看更详细的 log。</p><p>这一配置会自动挂载，而且只有在访问挂载目录时真正挂载。</p><h2 id=onedrive写于-2020-年可能已过时仅供参考>OneDrive（写于 2020 年，可能已过时，仅供参考）</h2><p>Rclone 提供了简单的交互式配置方式，运行 <code>rclone config</code> 即可，一般就是打开浏览器获取一个 token，网上有很多教程，在此就不赘述了。</p><p>以 OneDrive for Business 为例，主要说明一下如何在没有图形界面的情况下获取 token。</p><p>一种是先用其他带图形界面的系统配置一次，直接把 token 复制过去。</p><p>另一种就是在命令行下执行到这一步时：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>Use auto config?
</span></span><span class=line><span class=cl> * Say Y <span class=k>if</span> not sure
</span></span><span class=line><span class=cl> * Say N <span class=k>if</span> you are working on a remote or headless machine
</span></span><span class=line><span class=cl>y<span class=o>)</span> Yes
</span></span><span class=line><span class=cl>n<span class=o>)</span> No
</span></span><span class=line><span class=cl>y/n&gt; y
</span></span><span class=line><span class=cl>If your browser doesn<span class=err>&#39;</span>t open automatically go to the following link: http://127.0.0.1:53682/auth?state<span class=o>=</span>xxxxxxxxxxxxxxxxxxxxxx
</span></span><span class=line><span class=cl>Log in and authorize rclone <span class=k>for</span> access
</span></span><span class=line><span class=cl>Waiting <span class=k>for</span> code...
</span></span></code></pre></div><p>选择 <code>y</code> 的话理论上会打开浏览器访问那个地址，当然由于是服务器，不可能打开浏览器，这时我们重开一个 SSH 连接，并用 <code>curl</code> 访问：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ curl http://127.0.0.1:53682/auth?state<span class=o>=</span>xxxxxxxxxxxxxxxxxxxxxx
</span></span><span class=line><span class=cl>&lt;a <span class=nv>href</span><span class=o>=</span><span class=s2>&#34;https://login.microsoftonline.com/common/oauth2/v2.0/authorize?access_type=offline&amp;amp;client_id=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&amp;amp;redirect_uri=http%3A%2F%2Flocalhost%3A53682%2F&amp;amp;response_type=code&amp;amp;scope=Files.Read+Files.ReadWrite+Files.Read.All+Files.ReadWrite.All+offline_access&amp;amp;state=xxxxxxxxxxxxxxxxxxxxxx&#34;</span>&gt;Temporary Redirect&lt;/a&gt;.
</span></span></code></pre></div><p>复制 <code>href</code> 中的链接，对其 URL 解码，可以使用 Python 或其它工具，如：<a href=https://tool.chinaz.com/tools/urlencode.aspx target=_blank rel="noopener noreferrer">https://tool.chinaz.com/tools/urlencode.aspx</a></p><p>接着（客户端）使用浏览器访问解码后的 URL 并登陆账号，然后会重定向到一个本地 URL，在服务器上用 <code>curl</code> 访问此 URL。</p><p>这时 Rclone 的配置应该会自动进行到下一步，其它照常配置即可。如果不行就多试几次。</p><h3 id=挂载>挂载</h3><p>安装 FUSE：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo apt install fuse
</span></span></code></pre></div><p>将名为 <code>onedrive</code> 的配置挂载到 <code>/mnt/onedrive</code> 下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ rclone mount onedrive:/ /mnt/onedrive --vfs-cache-mode full --vfs-cache-max-age 24h --vfs-cache-max-size 12G
</span></span></code></pre></div><p>其中 <code>vfs-cache-mode</code> 可选参数为 <code>off|minimal|writes|full</code>，默认为 <code>off</code>，写入文件时无法随机寻址，因此无法用于 aria2、Transmission 等分块下载软件。<code>writes</code> 或 <code>full</code> 则可以很好地模拟本地文件系统，<code>writes</code> 模式下只读打开的文件无缓存，<code>full</code> 模式下读写均有缓存。</p><p><code>vfs-cache-max-age</code> 设置缓存保存时间，<code>vfs-cache-max-size</code> 设置缓存大小。</p><p>有一个很重要的参数 <code>--allow-other</code>，表示允许其他用户访问挂载的目录，否则默认其他用户无法访问，不注意的话根本无从排查。而这个参数要求配置 fuse，将 <code>/etc/fuse.conf</code> 中的 <code>user_allow_other</code> 取消注释。<code>--allow-root</code> 参数允许 root 用户访问，同样需要设置 <code>user_allow_other</code>。</p><p>参数 <code>-vv</code> 可查看 log 以排查错误，<code>--daemon</code> 以守护进程运行等。更多可参考：<a href=https://rclone.org/commands/rclone_mount/ target=_blank rel="noopener noreferrer">https://rclone.org/commands/rclone_mount/</a></p><p>查看一下是否已经挂载：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ df -h
</span></span><span class=line><span class=cl>Filesystem      Size  Used Avail Use% Mounted on
</span></span><span class=line><span class=cl>onedrive:       5.0T   18G  5.0T   1% /mnt/onedrive
</span></span></code></pre></div><h3 id=开机自启>开机自启</h3><p>systemd 脚本：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ cat /etc/systemd/system/rclone.service
</span></span><span class=line><span class=cl><span class=o>[</span>Unit<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>Description</span><span class=o>=</span>Rclone Service
</span></span><span class=line><span class=cl><span class=nv>Wants</span><span class=o>=</span>network-online.target
</span></span><span class=line><span class=cl><span class=nv>After</span><span class=o>=</span>network-online.target
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>Service<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>Type</span><span class=o>=</span>simple
</span></span><span class=line><span class=cl><span class=nv>User</span><span class=o>=</span>username
</span></span><span class=line><span class=cl><span class=nv>ExecStart</span><span class=o>=</span>/usr/bin/rclone mount onedrive:/ /mnt/onedrive --vfs-cache-mode full --vfs-cache-max-age 24h --vfs-cache-max-size 12G
</span></span><span class=line><span class=cl><span class=nv>ExecStopPost</span><span class=o>=</span>/bin/fusermount -qzu /mnt/onedrive
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>Install<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>WantedBy</span><span class=o>=</span>multi-user.target
</span></span></code></pre></div><p>其中 <code>User</code> 设置为所运行的用户。</p><p>我实际使用时，停止进程后无法自动取消挂载，文件夹异常，因此用 <code>fusermount -qzu /mnt/onedrive</code> 取消挂载。</p><p>另外，开机时 Transmission 可能会在 Rclone 之前运行，此时目录未挂载，Transmission 就会出错，于是修改其 systemd 脚本：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ vim /lib/systemd/system/transmission-daemon.service
</span></span></code></pre></div><p>将 <code>After=network.target</code> 修改为 <code>After=network.target rclone.service</code>，这样 Transmission 就在 Rclone 后启动。</p></article><section class="article labels"><a class=tag href=/tags/linux/>Linux</a></section><section class="article license"><p xmlns:cc=http://creativecommons.org/ns# style=text-align:center>本作品根据 <a href=http://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank rel="license noopener noreferrer" style=display:inline-block>署名-非商业性使用-相同方式共享 4.0 国际许可<img style=height:15px!important;margin-left:1px;vertical-align:text-bottom src=/cc-icons/cc.svg><img style=height:15px!important;margin-left:1px;vertical-align:text-bottom src=/cc-icons/by.svg><img style=height:15px!important;margin-left:1px;vertical-align:text-bottom src=/cc-icons/nc.svg><img style=height:15px!important;margin-left:1px;vertical-align:text-bottom src=/cc-icons/sa.svg></a> 进行授权。</p></section></div><div class="article bottom"><section class="article navigation"><p><a class=link href=/posts/adapter-pattern/><span class="iconfont icon-article"></span>适配器模式 Adapter Pattern</a></p><p><a class=link href=/posts/builder-pattern/><span class="iconfont icon-article"></span>生成器模式 Builder Pattern</a></p></section><section class="article discussion"><script>function loadComment(){let e=document.createElement("script");e.src="https://utteranc.es/client.js",e.setAttribute("repo","qianbinbin/qianbinbin.github.io"),e.setAttribute("issue-term","pathname"),e.setAttribute("theme","preferred-color-scheme"),e.setAttribute("crossorigin","anonymous"),e.setAttribute("async",""),document.querySelector("section.article.discussion").innerHTML="",document.querySelector("section.article.discussion").appendChild(e)}loadComment(),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{loadComment()})</script></section></div></section><section id=footer><div class=footer-wrap><p class=copyright>© 2017-2024 Binac.</p></div></section><script async src="https://www.googletagmanager.com/gtag/js?id=G-N7VZY53PLB"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-N7VZY53PLB")}</script><script src=https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js></script><script>addBackToTop({diameter:42})</script></body></html>