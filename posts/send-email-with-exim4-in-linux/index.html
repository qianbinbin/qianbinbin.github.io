<!doctype html><html lang=zh><meta charset=utf-8><meta name=generator content="Hugo 0.136.2"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light dark"><meta name=supported-color-schemes content="light dark"><link rel=icon href=/favicons/favicon.svg><title>在 Linux 上使用 Exim4 发送邮件&nbsp;&ndash;&nbsp;Binac</title><link rel=stylesheet href=/css/core.min.d30edcc615d78b7f8a2a9e5f1b66bd074a7ad2e94b579fa5902d0967ce0f7684b300ef3a9e15d41af82c75f3fb951d4b.css integrity=sha384-0w7cxhXXi3+KKp5fG2a9B0p60ulLV5+lkC0JZ84PdoSzAO86nhXUGvgsdfP7lR1L><meta name=twitter:card content="summary">
<meta name=twitter:title content="在 Linux 上使用 Exim4 发送邮件"><body><section id=header><div class="header wrap"><span class="header left-side"><a class="site home" href=/><img class="site logo" src=/favicons/favicon.svg alt><span class="site name">Binac</span></a></span>
<span class="header right-side"><div class="nav wrap"><nav class=nav><a class='nav item active' href=/posts/ title=文章>文章</a>
<a class='nav item' href=/nonsense/ title=妄言>妄言</a>
<a class='nav item' href=/tuya/ title=涂鸦>涂鸦</a>
<a class='nav item' href=/tags/ title>标签</a></nav></div></span></div></section><section id=content><div class=article-container><section class="article header"><h1 class="article title">在 Linux 上使用 Exim4 发送邮件</h1><p class="article date">2023-05-12<span class=lastmod> • 更新于 2024-02-17</span></p></section><article class="article markdown-body"><p>带有 GUI 的 Linux 可以直接使用集成的邮件客户端，比如 Thunderbird。但在服务器上，发送邮件需要一些配置，踩一些坑。</p><p>邮件系统由三个部分组成：</p><ul><li>Mail User Agent (MUA)，发送和接收邮件。</li><li>Mail Transfer Agent (MTA)，在计算机之间传输邮件。</li><li>Mail Delivery Agent (MDA)，将收到的邮件投递到用户收件箱。</li></ul><p>MUA 我使用的是 GNU Mailutils，MTA/MDA 使用的是 Exim4。</p><p><del>下面以网易 163 邮箱为例，</del> 说明怎么在 Debian 11 上配置 Exim4。</p><p>脑瘫的网易把我服务器 IP 屏蔽了，发邮件就报 553 错误：</p><pre tabindex=0><code>1rbFr0-005yuc-14 &lt;= fuck.netease@163.com U=root P=local S=459
1rbFr0-005yuc-14 H=smtp163.mail.ntes53.netease.com [103.129.252.45] TLS error on connection (recv): The TLS connection was non-properly terminated.
1rbFr0-005yuc-14 ** ?@hotmail.com R=smarthost T=remote_smtp_smarthost H=smtp163.mail.ntes53.netease.com [103.129.252.45] X=TLS1.3:ECDHE_SECP256R1__RSA_PSS_RSAE_SHA256__AES_256_GCM:256 CV=yes DN=&#34;C=CN,ST=zhejiang,L=hangzhou,O=NetEase (Hangzhou) Network Co.\, Ltd,CN=*.163.com&#34;: SMTP error from remote mail server after pipelined MAIL FROM:&lt;fuck.netease@163.com&gt;: 553 authentication is required,163 zwqz-smtp-mta-g5-0,_____wD3_4Uba9BlKz4cCQ--.10347S2 1708157724
1rbFr3-005yug-0L &lt;= &lt;&gt; R=1rbFr0-005yuc-14 U=Debian-exim P=local S=2232
1rbFr0-005yuc-14 Completed
1rbFr3-005yug-0L H=smtp163.mail.ntes53.netease.com [103.129.252.45] TLS error on connection (recv): The TLS connection was non-properly terminated.
1rbFr3-005yug-0L ** fuck.netease@163.com R=smarthost T=remote_smtp_smarthost H=smtp163.mail.ntes53.netease.com [103.129.252.45] X=TLS1.3:ECDHE_SECP256R1__RSA_PSS_RSAE_SHA256__AES_256_GCM:256 CV=yes DN=&#34;C=CN,ST=zhejiang,L=hangzhou,O=NetEase (Hangzhou) Network Co.\, Ltd,CN=*.163.com&#34;: SMTP error from remote mail server after pipelined MAIL FROM:&lt;&gt;: 553 NULL sender is not allowed,163 zwqz-smtp-mta-g5-3,_____wD3_7kda9Bly_Y5Aw--.8516S2 1708157726
1rbFr3-005yug-0L Frozen (delivery error message)
</code></pre><p>换 QQ 邮箱了，但是教程对网易也适用，前提是你的 IP 没被屏蔽。</p><p>先安装：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># apt install exim4 mailutils</span>
</span></span></code></pre></div><h2 id=smtp-端口号>SMTP 端口号</h2><h3 id=25>25</h3><p>25 端口最初作为明文传输的 SMTP 端口，现在经常被 ISP 和云服务器提供商屏蔽，说是为了防止垃圾邮件。颇有点掩耳盗铃的意思。</p><p>使用 telnet 检测端口是否可用：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ telnet smtp.163.com <span class=m>25</span>
</span></span></code></pre></div><p>个人测试发现，家用电信宽带、Vultr 可用，AWS 不可用。</p><h3 id=465>465</h3><p>465 是非标准的 SMTPS 端口，SMTPS 实际上就是 SMTP + TLS，类似 HTTPS 和 HTTP 的关系。虽然不是标准端口，但有很多邮件提供商提供支持。</p><h3 id=587>587</h3><p>587 是现在比较通用的标准端口，一般支持 STARTTLS 加密通信。</p><h3 id=qq-邮箱>QQ 邮箱</h3><p>从上面我们可以知道，SMTP 端口为 25，TLS 版本为 465，STARTTLS 版本为 587。</p><p>后两者支持加密通信，不过只要支持 STARTTLS，25 端口也可以加密通信。</p><p>QQ 邮箱符合标准，即 465 支持 SMTPS，587 支持 STARTTLS。</p><h3 id=网易邮箱>网易邮箱</h3><p>网易比较坑爹，它确实支持 25、465、587 三个端口，但只有 25 支持 STARTTLS，后两者都是 SMTPS，而它显然没有在官网进行相关说明。</p><p>我们可以在 <a href=https://esmtp.email/tools/tls/ target=_blank rel="noopener noreferrer">https://esmtp.email/tools/tls/</a> 检测加密支持情况。</p><h2 id=配置-exim4>配置 Exim4</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># dpkg-reconfigure exim4-config</span>
</span></span></code></pre></div><p>这会打开一个 TUI 配置向导。</p><p>选用 <code>mail sent by smarthost</code> 方案，<code>System mail name</code> 使用 <code>localhost</code>，IP 使用默认的环回地址，<code>Other destinations for which mail is accepted</code>、<code>Machines to relay mail for</code> 都留空。</p><p><code>IP address or host name of the outgoing smarthost</code> 填入 <code>smtp.qq.com::587</code>，注意两个半角冒号，这里使用 STARTTLS，配置比 SMTPS 简单。</p><p>如果用网易 163，就填入 <code>smtp.163.com::465</code>，这里的 465 是网易支持的 SMTPS 端口，587 也可以，因为网易这逗比俩端口都是 SMTPS，效果完全一样。</p><p>其余选项按喜好配置即可。</p><p>需要注意的是，出于安全原因，root 用户不能接收邮件，因此最后一步设置 alias 时，通常设置为日常使用的用户，root 收到的邮件将投递到此用户收件箱内。</p><p>这些设置体现在 <code>/etc/aliases</code> 中。我们还可以设置当用户收到邮件时，将邮件投递到某个互联网邮箱，例如：</p><pre tabindex=0><code>root: admin
admin: admin@example.com
</code></pre><p>运行 <code>newaliases</code> 使其生效。当系统收到邮件时（例如 Cron 定时任务），<code>admin@example.com</code> 就可以收到邮件提醒了。</p><p>然后在 <code>/etc/exim4/passwd.client</code> 中配置邮箱和密码：</p><pre tabindex=0><code># QQ
smtp.qq.com:username@qq.com:password
# 163
smtp.163.com:username@163.com:password
</code></pre><p>对于 QQ 和网易，这里的密码都要用授权码，登录 <a href=https://mail.qq.com target=_blank rel="noopener noreferrer">https://mail.qq.com</a> <a href=https://mail.163.com target=_blank rel="noopener noreferrer">https://mail.163.com</a> 获取。</p><p>接着还要配置一下 <code>/etc/email-addresses</code>，这是本地用户发送邮件时的邮箱，与上面一致：</p><pre tabindex=0><code># QQ
root:username@qq.com
admin:username@qq.com
</code></pre><p>更新配置并重启服务：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># update-exim4.conf</span>
</span></span><span class=line><span class=cl><span class=c1># service exim4 restart</span>
</span></span></code></pre></div><p>发个邮件试试：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=s2>&#34;邮件内容&#34;</span> <span class=p>|</span> mail -s <span class=s2>&#34;邮件标题&#34;</span> admin@example.com
</span></span></code></pre></div><p>日志位于 <code>/var/log/exim4/mainlog</code>。</p><p>如果你是 STARTTLS，那应该已经发送成功了。但我的日志里有莫名其妙的报错：</p><pre tabindex=0><code>1rbGz9-005zg6-1O H=smtp.qq.com [240e:ff:f100:1009::120] TLS error on connection (recv): Function was interrupted.
</code></pre><p>原因不明，但确实发送成功了。</p><p>SMTPS 还需要接下来的一些配置。</p><h2 id=smtps-配置1>SMTPS 配置<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></h2><p>STARTTLS 请忽略此步骤。</p><p>创建 <code>/etc/exim4/exim4.conf.localmacros</code>：</p><pre tabindex=0><code>MAIN_TLS_ENABLE = 1
REMOTE_SMTP_SMARTHOST_HOSTS_REQUIRE_TLS = *
TLS_ON_CONNECT_PORTS = 465
REQUIRE_PROTOCOL = smtps
</code></pre><p>注意端口 465 与上面一致。</p><p>编辑 <code>/etc/exim4/exim4.conf.template</code>，在 <code>.ifdef REMOTE_SMTP_SMARTHOST_HOSTS_REQUIRE_TLS ... .endif</code> 后（注意 <code>.endif</code>）添加：</p><pre tabindex=0><code>.ifdef REQUIRE_PROTOCOL
    protocol = REQUIRE_PROTOCOL
.endif
</code></pre><p>在 <code>.ifdef MAIN_TLS_ENABLE</code> 后添加：</p><pre tabindex=0><code>.ifdef TLS_ON_CONNECT_PORTS
    tls_on_connect_ports = TLS_ON_CONNECT_PORTS
.endif
</code></pre><p>更新配置并重启服务：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># update-exim4.conf</span>
</span></span><span class=line><span class=cl><span class=c1># service exim4 restart</span>
</span></span></code></pre></div><p>运行 <code>exim4 -qff</code> 强制发送之前发送失败而暂存的邮件。</p><p>这下终于可以了。</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://wiki.debian.org/Exim#Communicating_with_a_smarthost target=_blank rel="noopener noreferrer">https://wiki.debian.org/Exim#Communicating_with_a_smarthost</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></article><section class="article labels"><a class=tag href=/tags/linux/>Linux</a></section><section class="article license"><p xmlns:cc=http://creativecommons.org/ns# style=text-align:center>本作品根据 <a href=http://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank rel="license noopener noreferrer" style=display:inline-block>署名-非商业性使用-相同方式共享 4.0 国际许可<img style=height:15px!important;margin-left:1px;vertical-align:text-bottom src=/cc-icons/cc.svg><img style=height:15px!important;margin-left:1px;vertical-align:text-bottom src=/cc-icons/by.svg><img style=height:15px!important;margin-left:1px;vertical-align:text-bottom src=/cc-icons/nc.svg><img style=height:15px!important;margin-left:1px;vertical-align:text-bottom src=/cc-icons/sa.svg></a> 进行授权。</p></section></div><div class="article bottom"><section class="article navigation"><p><a class=link href=/posts/video-related-commands-and-scripts/><span class="iconfont icon-article"></span>视频相关的命令和脚本</a></p><p><a class=link href=/posts/problems-with-homebrew/><span class="iconfont icon-article"></span>Homebrew 使用中的一些问题</a></p></section><section class="article discussion"><script>function loadComment(){let e=document.createElement("script");e.src="https://utteranc.es/client.js",e.setAttribute("repo","qianbinbin/qianbinbin.github.io"),e.setAttribute("issue-term","pathname"),e.setAttribute("theme","preferred-color-scheme"),e.setAttribute("crossorigin","anonymous"),e.setAttribute("async",""),document.querySelector("section.article.discussion").innerHTML="",document.querySelector("section.article.discussion").appendChild(e)}loadComment(),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{loadComment()})</script></section></div></section><section id=footer><div class=footer-wrap><p class=copyright>© 2017-2024 Binac.</p></div></section><script async src="https://www.googletagmanager.com/gtag/js?id=G-N7VZY53PLB"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-N7VZY53PLB")}</script><script src=https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js></script><script>addBackToTop({diameter:42})</script></body></html>