<!doctype html><html lang=zh><meta charset=utf-8><meta name=generator content="Hugo 0.136.2"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light dark"><meta name=supported-color-schemes content="light dark"><link rel=icon href=/favicons/favicon.svg><title>视频相关的命令和脚本&nbsp;&ndash;&nbsp;Binac</title><link rel=stylesheet href=/css/core.min.d30edcc615d78b7f8a2a9e5f1b66bd074a7ad2e94b579fa5902d0967ce0f7684b300ef3a9e15d41af82c75f3fb951d4b.css integrity=sha384-0w7cxhXXi3+KKp5fG2a9B0p60ulLV5+lkC0JZ84PdoSzAO86nhXUGvgsdfP7lR1L><meta name=twitter:card content="summary">
<meta name=twitter:title content="视频相关的命令和脚本"><body><section id=header><div class="header wrap"><span class="header left-side"><a class="site home" href=/><img class="site logo" src=/favicons/favicon.svg alt><span class="site name">Binac</span></a></span>
<span class="header right-side"><div class="nav wrap"><nav class=nav><a class='nav item active' href=/posts/ title=文章>文章</a>
<a class='nav item' href=/nonsense/ title=妄言>妄言</a>
<a class='nav item' href=/tuya/ title=涂鸦>涂鸦</a>
<a class='nav item' href=/tags/ title>标签</a></nav></div></span></div></section><section id=content><div class=article-container><section class="article header"><h1 class="article title">视频相关的命令和脚本</h1><p class="article date">2023-11-22<span class=lastmod> • 更新于 2024-05-27</span></p></section><article class="article markdown-body"><h2 id=ffmpeg-实用命令>FFmpeg 实用命令</h2><h3 id=剪切视频而不重新转码1>剪切视频而不重新转码<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ ffmpeg -ss 00:00:30.0 -to 00:00:40.0 -i input.mp4 -c copy output.mp4
</span></span></code></pre></div><p><code>-ss</code> 和 <code>-to</code> 分别指定起始时间。</p><p>这种方式输出的视频有一定问题，最好还是转码（不要用 <code>-c copy</code>）。</p><h3 id=codec-not-currently-supported-in-container2>codec not currently supported in container<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup></h3><p>一些视频流和音频流无法放到同一容器中，例如 WMA 音频不能与 H.264 视频兼容，解决方式是将音频也转码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ ffmpeg -i input.wmv -c:v libx264 -c:a aac output.mp4
</span></span></code></pre></div><h3 id=旋转视频而不转码3>旋转视频而不转码<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup></h3><p><strong>逆时针</strong>旋转 90 度：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ ffmpeg -display_rotation <span class=m>90</span> -i input.mp4 -c copy output.mp4
</span></span></code></pre></div><h3 id=裁切视频4>裁切视频<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ ffmpeg -i input.mp4 -vf <span class=s2>&#34;crop=out_w:out_h:x:y&#34;</span> -c:a copy output.mp4
</span></span></code></pre></div><p><code>crop=</code> 后以 <code>:</code> 分隔的四个参数分别表示：输出宽度、输出高度、左上角横坐标、左上角纵坐标。</p><h3 id=循环重复5>循环重复<sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup></h3><p>循环重复 3 次：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ ffmpeg -stream_loop <span class=m>3</span> -i input.mp4 -c copy output.mp4
</span></span></code></pre></div><h3 id=合并多个同类文件而不转码6>合并多个同类文件而不转码<sup id=fnref:6><a href=#fn:6 class=footnote-ref role=doc-noteref>6</a></sup></h3><p>使用一个文本保存需合并的文件路径，如 <code>input.txt</code>：</p><pre tabindex=0><code>file &#39;path/to/part1.mp4&#39;
file &#39;path/to/part2.mp4&#39;
file &#39;path/to/part3.mp4&#39;
</code></pre><p>然后：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ ffmpeg -f concat -i input.txt -c copy output.mp4
</span></span></code></pre></div><h3 id=去隔行扫描7>去隔行扫描<sup id=fnref:7><a href=#fn:7 class=footnote-ref role=doc-noteref>7</a></sup></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ ffmpeg -i input.vob -vf yadif -c:a copy output.mp4
</span></span></code></pre></div><h3 id=视频加速减速8>视频加速/减速<sup id=fnref:8><a href=#fn:8 class=footnote-ref role=doc-noteref>8</a></sup></h3><p>加速两倍：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ ffmpeg -i input.mp4 -vf <span class=s2>&#34;setpts=0.5*PTS&#34;</span> output.mp4
</span></span></code></pre></div><p>减速一半：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ ffmpeg -i input.mp4 -vf <span class=s2>&#34;setpts=2*PTS&#34;</span> output.mp4
</span></span></code></pre></div><h3 id=视频反转9>视频反转<sup id=fnref:9><a href=#fn:9 class=footnote-ref role=doc-noteref>9</a></sup></h3><p>仅反转视频：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ ffmpeg -i input.mp4 -vf reverse output.mp4
</span></span></code></pre></div><p>同时反转视频和音频：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ ffmpeg -i input.mp4 -vf reverse -af areverse output.mp4
</span></span></code></pre></div><h3 id=hev1-转-hvc110>hev1 转 hvc1<sup id=fnref:10><a href=#fn:10 class=footnote-ref role=doc-noteref>10</a></sup></h3><p>一些 HEVC 在 macOS 上无法显示缩略图，也无法用原生 APP 打开，这是因为使用了 hev1：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ ffprobe -v error -select_streams v -show_entries <span class=nv>stream</span><span class=o>=</span>codec_tag_string -of <span class=nv>default</span><span class=o>=</span><span class=nv>noprint_wrappers</span><span class=o>=</span>1:nokey<span class=o>=</span><span class=m>1</span> input.mp4
</span></span><span class=line><span class=cl>hev1
</span></span></code></pre></div><p>转换为 hvc1 即可：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ ffmpeg -i input.mp4 -tag:v hvc1 -c copy output.mp4
</span></span><span class=line><span class=cl>$ ffprobe -v error -select_streams v -show_entries <span class=nv>stream</span><span class=o>=</span>codec_tag_string -of <span class=nv>default</span><span class=o>=</span><span class=nv>noprint_wrappers</span><span class=o>=</span>1:nokey<span class=o>=</span><span class=m>1</span> output.mp4
</span></span><span class=line><span class=cl>hvc1
</span></span></code></pre></div><h2 id=脚本>脚本</h2><h3 id=列出码率最高的视频>列出码率最高的视频</h3><p>默认列出前 10 个，不支持含换行符的文件名。</p><p>使用 <code>-v</code> 选项以首个视频流码率列出（而不是总体码率），但不支持 MKV、TS、WebM 等容器。</p><figure style="margin:0 0 1.5em"><figcaption style=text-align:right><a href=/code/video-related-commands-and-scripts/top-videos-by-bitrate.sh style=color:lightslategrey;font-size:.8em>top-videos-by-bitrate.sh</a></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=cp>#!/usr/bin/env sh
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=nv>BRIEF</span><span class=o>=</span><span class=nb>false</span>
</span></span><span class=line><span class=cl><span class=nv>VIDEO_EXT</span><span class=o>=</span><span class=s2>&#34;3gp avi flv m4v mkv mov mp4 mpeg mpg ts vob webm wmv&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>NUM</span><span class=o>=</span><span class=m>10</span>
</span></span><span class=line><span class=cl><span class=nv>VIDEO_BITRATE</span><span class=o>=</span><span class=nb>false</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>SCRIPT</span><span class=o>=</span><span class=k>$(</span>basename <span class=s2>&#34;</span><span class=nv>$0</span><span class=s2>&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>USAGE</span><span class=o>=</span><span class=k>$(</span>
</span></span><span class=line><span class=cl>  cat <span class=s>&lt;&lt;-END
</span></span></span><span class=line><span class=cl><span class=s>Usage: $SCRIPT [&lt;options&gt;] &lt;path&gt;...
</span></span></span><span class=line><span class=cl><span class=s>List top videos by bitrate.
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  -b            do not prepend bitrate to output lines
</span></span></span><span class=line><span class=cl><span class=s>  -e &lt;ext&gt;      video file extensions, separated by spaces, case-insensitive
</span></span></span><span class=line><span class=cl><span class=s>                defaults to &#39;$VIDEO_EXT&#39;
</span></span></span><span class=line><span class=cl><span class=s>  -n &lt;num&gt;      list top num video files
</span></span></span><span class=line><span class=cl><span class=s>                defaults to &#39;$NUM&#39;
</span></span></span><span class=line><span class=cl><span class=s>  -v            list by the first video stream bitrate instead of the overall bitrate
</span></span></span><span class=line><span class=cl><span class=s>                not applicable for containers like MKV, TS, WebM, etc
</span></span></span><span class=line><span class=cl><span class=s>  -h            display this help and exit
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>Home page: &lt;https://binac.org/posts/video-related-commands-and-scripts/&gt;
</span></span></span><span class=line><span class=cl><span class=s>END</span>
</span></span><span class=line><span class=cl><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>error<span class=o>()</span> <span class=o>{</span> <span class=nb>printf</span> <span class=s2>&#34;%s\n&#34;</span> <span class=s2>&#34;</span><span class=nv>$@</span><span class=s2>&#34;</span> &gt;<span class=p>&amp;</span>2<span class=p>;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>_exit<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  error <span class=s2>&#34;</span><span class=nv>$USAGE</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nb>exit</span> <span class=m>2</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=nb>getopts</span> <span class=s2>&#34;bhve:n:&#34;</span> c<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=k>case</span> <span class=nv>$c</span> in
</span></span><span class=line><span class=cl>  b<span class=o>)</span> <span class=nv>BRIEF</span><span class=o>=</span><span class=nb>true</span> <span class=p>;;</span>
</span></span><span class=line><span class=cl>  e<span class=o>)</span> <span class=nv>VIDEO_EXT</span><span class=o>=</span><span class=nv>$OPTARG</span> <span class=p>;;</span>
</span></span><span class=line><span class=cl>  n<span class=o>)</span> <span class=nv>NUM</span><span class=o>=</span><span class=nv>$OPTARG</span> <span class=p>;;</span>
</span></span><span class=line><span class=cl>  v<span class=o>)</span> <span class=nv>VIDEO_BITRATE</span><span class=o>=</span><span class=nb>true</span> <span class=p>;;</span>
</span></span><span class=line><span class=cl>  h<span class=o>)</span> error <span class=s2>&#34;</span><span class=nv>$USAGE</span><span class=s2>&#34;</span> <span class=o>&amp;&amp;</span> <span class=nb>exit</span> <span class=p>;;</span>
</span></span><span class=line><span class=cl>  *<span class=o>)</span> _exit <span class=p>;;</span>
</span></span><span class=line><span class=cl>  <span class=k>esac</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>is_integer<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=o>[</span> -n <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span> -eq <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span> <span class=o>]</span> 2&gt;/dev/null
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>is_integer <span class=s2>&#34;</span><span class=nv>$NUM</span><span class=s2>&#34;</span> <span class=o>||</span> _exit
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>shift</span> <span class=k>$((</span>OPTIND <span class=o>-</span> <span class=m>1</span><span class=k>))</span>
</span></span><span class=line><span class=cl><span class=o>[</span> <span class=nv>$#</span> -eq <span class=m>0</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> _exit
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>min<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span> -le <span class=s2>&#34;</span><span class=nv>$2</span><span class=s2>&#34;</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span> <span class=o>||</span> <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$2</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>get_bitrate<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$VIDEO_BITRATE</span><span class=s2>&#34;</span> <span class=o>=</span> <span class=nb>false</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    ffprobe -v error -show_entries <span class=nv>format</span><span class=o>=</span>bit_rate -of <span class=nv>default</span><span class=o>=</span><span class=nv>noprint_wrappers</span><span class=o>=</span>1:nokey<span class=o>=</span><span class=m>1</span> <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>    ffprobe -v error -select_streams v:0 -show_entries <span class=nv>stream</span><span class=o>=</span>bit_rate -of <span class=nv>default</span><span class=o>=</span><span class=nv>noprint_wrappers</span><span class=o>=</span>1:nokey<span class=o>=</span><span class=m>1</span> <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span> <span class=p>|</span> head -n <span class=m>1</span>
</span></span><span class=line><span class=cl>  <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>TMP_FILE</span><span class=o>=</span><span class=k>$(</span>mktemp<span class=k>)</span> <span class=o>||</span> <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=nb>trap</span> <span class=s1>&#39;rm -f &#34;$TMP_FILE&#34;&#39;</span> EXIT
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>count</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=nv>grep_expression</span><span class=o>=</span><span class=s2>&#34;</span><span class=k>$(</span><span class=nb>echo</span> <span class=s2>&#34; </span><span class=nv>$VIDEO_EXT</span><span class=s2>&#34;</span> <span class=p>|</span> sed <span class=s1>&#39;s/ /\$|\\./g&#39;</span> <span class=p>|</span> cut -c3-<span class=k>)</span>$<span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>find <span class=s2>&#34;</span><span class=nv>$@</span><span class=s2>&#34;</span> -type f <span class=p>|</span> grep -i -E <span class=s2>&#34;</span><span class=nv>$grep_expression</span><span class=s2>&#34;</span> <span class=p>|</span> <span class=k>while</span> <span class=nv>IFS</span><span class=o>=</span> <span class=nb>read</span> -r f<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  : <span class=k>$((</span><span class=nv>count</span> <span class=o>+=</span> <span class=m>1</span><span class=k>))</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Detecting videos: %s\r&#34;</span> <span class=s2>&#34;</span><span class=nv>$count</span><span class=s2>&#34;</span> &gt;<span class=p>&amp;</span><span class=m>2</span>
</span></span><span class=line><span class=cl>  <span class=nv>br</span><span class=o>=</span><span class=k>$(</span>get_bitrate <span class=s2>&#34;</span><span class=nv>$f</span><span class=s2>&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> is_integer <span class=s2>&#34;</span><span class=nv>$br</span><span class=s2>&#34;</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;</span><span class=k>$(</span>numfmt --to iec <span class=s2>&#34;</span><span class=nv>$br</span><span class=s2>&#34;</span><span class=k>)</span><span class=s2>|</span><span class=nv>$f</span><span class=s2>&#34;</span> &gt;&gt;<span class=s2>&#34;</span><span class=nv>$TMP_FILE</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=nb>printf</span> <span class=s2>&#34;\n%s\n&#34;</span> <span class=s2>&#34;Cannot get bitrate: </span><span class=nv>$f</span><span class=s2>&#34;</span> &gt;<span class=p>&amp;</span><span class=m>2</span>
</span></span><span class=line><span class=cl>  <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span><span class=line><span class=cl><span class=nv>count</span><span class=o>=</span><span class=k>$(</span>wc -l &lt;<span class=s2>&#34;</span><span class=nv>$TMP_FILE</span><span class=s2>&#34;</span> <span class=p>|</span> xargs<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s2>&#34;\n&#34;</span> &gt;<span class=p>&amp;</span><span class=m>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$count</span><span class=s2>&#34;</span> -eq <span class=m>0</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  error <span class=s2>&#34;No videos found&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nb>exit</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>  error <span class=s2>&#34;Detected </span><span class=nv>$count</span><span class=s2> videos&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>error <span class=s2>&#34;Top </span><span class=k>$(</span>min <span class=s2>&#34;</span><span class=nv>$NUM</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$count</span><span class=s2>&#34;</span><span class=k>)</span><span class=s2> videos by bitrate:&#34;</span>
</span></span><span class=line><span class=cl><span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$BRIEF</span><span class=s2>&#34;</span> <span class=o>=</span> <span class=nb>true</span> <span class=o>]</span> <span class=o>||</span> <span class=nb>printf</span> <span class=s2>&#34;%-16s%s\n&#34;</span> <span class=s2>&#34;Bitrate&#34;</span> <span class=s2>&#34;File&#34;</span>
</span></span><span class=line><span class=cl>sort -t <span class=s1>&#39;|&#39;</span> -k1 -hr <span class=s2>&#34;</span><span class=nv>$TMP_FILE</span><span class=s2>&#34;</span> <span class=p>|</span> head -n <span class=s2>&#34;</span><span class=nv>$NUM</span><span class=s2>&#34;</span> <span class=p>|</span> <span class=k>while</span> <span class=nv>IFS</span><span class=o>=</span> <span class=nb>read</span> -r line<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=nv>br</span><span class=o>=</span><span class=k>$(</span><span class=nb>echo</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>line</span><span class=p>%%|*</span><span class=si>}</span><span class=s2>&#34;</span> <span class=p>|</span> xargs<span class=k>)</span>
</span></span><span class=line><span class=cl>  <span class=nv>f</span><span class=o>=</span><span class=si>${</span><span class=nv>line</span><span class=p>#*|</span><span class=si>}</span>
</span></span><span class=line><span class=cl>  <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$BRIEF</span><span class=s2>&#34;</span> <span class=o>=</span> <span class=nb>true</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$f</span><span class=s2>&#34;</span> <span class=o>||</span> <span class=nb>printf</span> <span class=s2>&#34;%-16s%s\n&#34;</span> <span class=s2>&#34;</span><span class=nv>$br</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$f</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span></code></pre></div></figure><p>示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ top-videos-by-bitrate.sh -n <span class=m>3</span> /path/to/videos
</span></span><span class=line><span class=cl>Detecting videos: <span class=m>100</span>
</span></span><span class=line><span class=cl>Detected <span class=m>100</span> videos
</span></span><span class=line><span class=cl>Top <span class=m>3</span> videos by bitrate:
</span></span><span class=line><span class=cl>Bitrate         File
</span></span><span class=line><span class=cl>8.8M            /path/to/videos/1.mp4
</span></span><span class=line><span class=cl>4.2M            /path/to/videos/2/3.avi
</span></span><span class=line><span class=cl>3.8M            /path/to/videos/4/5/6.mkv
</span></span></code></pre></div><h3 id=列出占用空间最大的视频>列出占用空间最大的视频</h3><p>使用 du 命令检测磁盘占用空间（而不是实际大小）。</p><p>默认列出前 10 个，不支持含换行符的文件名。</p><figure style="margin:0 0 1.5em"><figcaption style=text-align:right><a href=/code/video-related-commands-and-scripts/top-videos-by-size.sh style=color:lightslategrey;font-size:.8em>top-videos-by-size.sh</a></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=cp>#!/usr/bin/env sh
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=nv>BRIEF</span><span class=o>=</span><span class=nb>false</span>
</span></span><span class=line><span class=cl><span class=nv>VIDEO_EXT</span><span class=o>=</span><span class=s2>&#34;3gp avi flv m4v mkv mov mp4 mpeg mpg ts vob webm wmv&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>NUM</span><span class=o>=</span><span class=m>10</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>SCRIPT</span><span class=o>=</span><span class=k>$(</span>basename <span class=s2>&#34;</span><span class=nv>$0</span><span class=s2>&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>USAGE</span><span class=o>=</span><span class=k>$(</span>
</span></span><span class=line><span class=cl>  cat <span class=s>&lt;&lt;-END
</span></span></span><span class=line><span class=cl><span class=s>Usage: $SCRIPT [&lt;options&gt;] &lt;path&gt;...
</span></span></span><span class=line><span class=cl><span class=s>List top videos by size.
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  -b            do not prepend size to output lines
</span></span></span><span class=line><span class=cl><span class=s>  -e &lt;ext&gt;      video file extensions, separated by spaces, case-insensitive
</span></span></span><span class=line><span class=cl><span class=s>                defaults to &#39;$VIDEO_EXT&#39;
</span></span></span><span class=line><span class=cl><span class=s>  -n &lt;num&gt;      list top num video files
</span></span></span><span class=line><span class=cl><span class=s>                defaults to &#39;$NUM&#39;
</span></span></span><span class=line><span class=cl><span class=s>  -h            display this help and exit
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>Home page: &lt;https://binac.org/posts/video-related-commands-and-scripts/&gt;
</span></span></span><span class=line><span class=cl><span class=s>END</span>
</span></span><span class=line><span class=cl><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>error<span class=o>()</span> <span class=o>{</span> <span class=nb>printf</span> <span class=s2>&#34;%s\n&#34;</span> <span class=s2>&#34;</span><span class=nv>$@</span><span class=s2>&#34;</span> &gt;<span class=p>&amp;</span>2<span class=p>;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>_exit<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  error <span class=s2>&#34;</span><span class=nv>$USAGE</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nb>exit</span> <span class=m>2</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=nb>getopts</span> <span class=s2>&#34;bhe:n:&#34;</span> c<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=k>case</span> <span class=nv>$c</span> in
</span></span><span class=line><span class=cl>  b<span class=o>)</span> <span class=nv>BRIEF</span><span class=o>=</span><span class=nb>true</span> <span class=p>;;</span>
</span></span><span class=line><span class=cl>  e<span class=o>)</span> <span class=nv>VIDEO_EXT</span><span class=o>=</span><span class=nv>$OPTARG</span> <span class=p>;;</span>
</span></span><span class=line><span class=cl>  n<span class=o>)</span> <span class=nv>NUM</span><span class=o>=</span><span class=nv>$OPTARG</span> <span class=p>;;</span>
</span></span><span class=line><span class=cl>  h<span class=o>)</span> error <span class=s2>&#34;</span><span class=nv>$USAGE</span><span class=s2>&#34;</span> <span class=o>&amp;&amp;</span> <span class=nb>exit</span> <span class=p>;;</span>
</span></span><span class=line><span class=cl>  *<span class=o>)</span> _exit <span class=p>;;</span>
</span></span><span class=line><span class=cl>  <span class=k>esac</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>is_integer<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=o>[</span> -n <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span> -eq <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span> <span class=o>]</span> 2&gt;/dev/null
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>is_integer <span class=s2>&#34;</span><span class=nv>$NUM</span><span class=s2>&#34;</span> <span class=o>||</span> _exit
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>shift</span> <span class=k>$((</span>OPTIND <span class=o>-</span> <span class=m>1</span><span class=k>))</span>
</span></span><span class=line><span class=cl><span class=o>[</span> <span class=nv>$#</span> -eq <span class=m>0</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> _exit
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>min<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span> -le <span class=s2>&#34;</span><span class=nv>$2</span><span class=s2>&#34;</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span> <span class=o>||</span> <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$2</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>TMP_FILE</span><span class=o>=</span><span class=k>$(</span>mktemp<span class=k>)</span> <span class=o>||</span> <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=nb>trap</span> <span class=s1>&#39;rm -f &#34;$TMP_FILE&#34;&#39;</span> EXIT
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>grep_expression</span><span class=o>=</span><span class=s2>&#34;</span><span class=k>$(</span><span class=nb>echo</span> <span class=s2>&#34; </span><span class=nv>$VIDEO_EXT</span><span class=s2>&#34;</span> <span class=p>|</span> sed <span class=s1>&#39;s/ /\$|\\./g&#39;</span> <span class=p>|</span> cut -c3-<span class=k>)</span>$<span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>find <span class=s2>&#34;</span><span class=nv>$@</span><span class=s2>&#34;</span> -type f -exec du -h <span class=o>{}</span> + <span class=p>|</span> grep -i -E <span class=s2>&#34;</span><span class=nv>$grep_expression</span><span class=s2>&#34;</span> <span class=p>|</span> sort -h -r &gt;<span class=s2>&#34;</span><span class=nv>$TMP_FILE</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>count</span><span class=o>=</span><span class=k>$(</span>wc -l &lt;<span class=s2>&#34;</span><span class=nv>$TMP_FILE</span><span class=s2>&#34;</span> <span class=p>|</span> xargs<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$count</span><span class=s2>&#34;</span> -eq <span class=m>0</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  error <span class=s2>&#34;No videos found&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nb>exit</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>  error <span class=s2>&#34;Detected </span><span class=nv>$count</span><span class=s2> videos&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>error <span class=s2>&#34;Top </span><span class=k>$(</span>min <span class=s2>&#34;</span><span class=nv>$NUM</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$count</span><span class=s2>&#34;</span><span class=k>)</span><span class=s2> videos by size:&#34;</span>
</span></span><span class=line><span class=cl><span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$BRIEF</span><span class=s2>&#34;</span> <span class=o>=</span> <span class=nb>true</span> <span class=o>]</span> <span class=o>||</span> <span class=nb>printf</span> <span class=s2>&#34;%-16s%s\n&#34;</span> <span class=s2>&#34;Size&#34;</span> <span class=s2>&#34;File&#34;</span>
</span></span><span class=line><span class=cl>head -n <span class=s2>&#34;</span><span class=nv>$NUM</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$TMP_FILE</span><span class=s2>&#34;</span> <span class=p>|</span> <span class=k>while</span> <span class=nv>IFS</span><span class=o>=</span> <span class=nb>read</span> -r line<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=nv>sz</span><span class=o>=</span><span class=k>$(</span><span class=nb>echo</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>line</span><span class=p>%%	*</span><span class=si>}</span><span class=s2>&#34;</span> <span class=p>|</span> xargs<span class=k>)</span>
</span></span><span class=line><span class=cl>  <span class=nv>f</span><span class=o>=</span><span class=si>${</span><span class=nv>line</span><span class=p>#*	</span><span class=si>}</span>
</span></span><span class=line><span class=cl>  <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$BRIEF</span><span class=s2>&#34;</span> <span class=o>=</span> <span class=nb>true</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$f</span><span class=s2>&#34;</span> <span class=o>||</span> <span class=nb>printf</span> <span class=s2>&#34;%-16s%s\n&#34;</span> <span class=s2>&#34;</span><span class=nv>$sz</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$f</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span></code></pre></div></figure><p>示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ top-videos-by-size.sh -n <span class=m>3</span> /path/to/videos
</span></span><span class=line><span class=cl>Detected <span class=m>100</span> videos
</span></span><span class=line><span class=cl>Top <span class=m>3</span> videos by size:
</span></span><span class=line><span class=cl>Size            File
</span></span><span class=line><span class=cl>4.2G            /path/to/videos/1.mp4
</span></span><span class=line><span class=cl>420M            /path/to/videos/2/3.avi
</span></span><span class=line><span class=cl>42M             /path/to/videos/4/5/6.mkv
</span></span></code></pre></div><h3 id=hevc-转码>HEVC 转码</h3><p>将文件批量转为 HEVC 编码，只转码首条视频流，其他视频流、音频流、字幕流原封不动。</p><p>默认会忽略本身已经是 hevc/av1/vp9 编码的文件，因为这些编码已经效率很高了。使用 <code>-c &lt;codecs></code> 指定需要忽略的编码。</p><figure style="margin:0 0 1.5em"><figcaption style=text-align:right><a href=/code/video-related-commands-and-scripts/hevcize.sh style=color:lightslategrey;font-size:.8em>hevcize.sh</a></figcaption><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=cp>#!/usr/bin/env sh
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=nv>ARGUMENTS</span><span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>CODEC_WHITELIST</span><span class=o>=</span><span class=s2>&#34;hevc av1 vp9&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>AVAILABLE_ENCODERS</span><span class=o>=</span><span class=k>$(</span>ffmpeg -codecs 2&gt;/dev/null <span class=p>|</span> grep <span class=s1>&#39;^.\{8\}hevc&#39;</span> <span class=p>|</span> sed -n <span class=s1>&#39;s/.*(encoders: \([^)]*\)).*/\1/p&#39;</span> <span class=p>|</span> xargs<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>ENCODER</span><span class=o>=</span>libx265
</span></span><span class=line><span class=cl><span class=nv>OUTPUT_DIR</span><span class=o>=</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>SCRIPT</span><span class=o>=</span><span class=k>$(</span>basename <span class=s2>&#34;</span><span class=nv>$0</span><span class=s2>&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>USAGE</span><span class=o>=</span><span class=k>$(</span>
</span></span><span class=line><span class=cl>  cat <span class=s>&lt;&lt;-END
</span></span></span><span class=line><span class=cl><span class=s>Usage: $SCRIPT [&lt;options&gt;] &lt;file&gt;...
</span></span></span><span class=line><span class=cl><span class=s>List top videos by size.
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  -a &lt;args&gt;     pass extra arguments to ffmpeg
</span></span></span><span class=line><span class=cl><span class=s>  -c &lt;codecs&gt;   videos with these codecs will NOT be encoded
</span></span></span><span class=line><span class=cl><span class=s>                defaults to &#39;$CODEC_WHITELIST&#39;
</span></span></span><span class=line><span class=cl><span class=s>  -e &lt;encoder&gt;  set HEVC encoder, this could accelerate transcoding but reduce the quality
</span></span></span><span class=line><span class=cl><span class=s>                you may need to use &#39;-a &lt;args&gt;&#39;
</span></span></span><span class=line><span class=cl><span class=s>                available encoders: $AVAILABLE_ENCODERS
</span></span></span><span class=line><span class=cl><span class=s>                defaults to &#39;$ENCODER&#39;
</span></span></span><span class=line><span class=cl><span class=s>  -o &lt;dir&gt;      set output directory
</span></span></span><span class=line><span class=cl><span class=s>                by default, the output file will be placed in the same directory as the original video
</span></span></span><span class=line><span class=cl><span class=s>  -h            display this help and exit
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>Home page: &lt;https://binac.org/posts/video-related-commands-and-scripts/&gt;
</span></span></span><span class=line><span class=cl><span class=s>END</span>
</span></span><span class=line><span class=cl><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>THIN_LINE</span><span class=o>=</span><span class=k>$(</span><span class=nb>printf</span> <span class=s1>&#39;%.s-&#39;</span> <span class=k>$(</span>seq <span class=m>1</span> 80<span class=k>))</span>
</span></span><span class=line><span class=cl><span class=nv>BOLD_LINE</span><span class=o>=</span><span class=k>$(</span><span class=nb>printf</span> <span class=s1>&#39;%.s=&#39;</span> <span class=k>$(</span>seq <span class=m>1</span> 80<span class=k>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>error<span class=o>()</span> <span class=o>{</span> <span class=nb>printf</span> <span class=s2>&#34;%s\n&#34;</span> <span class=s2>&#34;</span><span class=nv>$@</span><span class=s2>&#34;</span> &gt;<span class=p>&amp;</span>2<span class=p>;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>_exit<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  error <span class=s2>&#34;</span><span class=nv>$USAGE</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nb>exit</span> <span class=m>2</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=nb>getopts</span> <span class=s2>&#34;ha:c:e:o:&#34;</span> c<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=k>case</span> <span class=nv>$c</span> in
</span></span><span class=line><span class=cl>  a<span class=o>)</span> <span class=nv>ARGUMENTS</span><span class=o>=</span><span class=nv>$OPTARG</span> <span class=p>;;</span>
</span></span><span class=line><span class=cl>  c<span class=o>)</span> <span class=nv>CODEC_WHITELIST</span><span class=o>=</span><span class=nv>$OPTARG</span> <span class=p>;;</span>
</span></span><span class=line><span class=cl>  e<span class=o>)</span> <span class=nv>ENCODER</span><span class=o>=</span><span class=nv>$OPTARG</span> <span class=p>;;</span>
</span></span><span class=line><span class=cl>  o<span class=o>)</span> <span class=nv>OUTPUT_DIR</span><span class=o>=</span><span class=nv>$OPTARG</span> <span class=p>;;</span>
</span></span><span class=line><span class=cl>  h<span class=o>)</span> error <span class=s2>&#34;</span><span class=nv>$USAGE</span><span class=s2>&#34;</span> <span class=o>&amp;&amp;</span> <span class=nb>exit</span> <span class=p>;;</span>
</span></span><span class=line><span class=cl>  *<span class=o>)</span> _exit <span class=p>;;</span>
</span></span><span class=line><span class=cl>  <span class=k>esac</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>contains<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span> <span class=p>|</span> grep -qs <span class=s2>&#34;\&lt;</span><span class=nv>$2</span><span class=s2>\&gt;&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> ! contains <span class=s2>&#34;</span><span class=nv>$AVAILABLE_ENCODERS</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$ENCODER</span><span class=s2>&#34;</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  error <span class=s2>&#34;Invalid encoder: &#39;</span><span class=nv>$ENCODER</span><span class=s2>&#39;&#34;</span>
</span></span><span class=line><span class=cl>  _exit
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> -z <span class=s2>&#34;</span><span class=nv>$ARGUMENTS</span><span class=s2>&#34;</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$ENCODER</span><span class=s2>&#34;</span> <span class=o>=</span> libx265 <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nv>ARGUMENTS</span><span class=o>=</span><span class=s2>&#34;-x265-params log-level=error&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> -n <span class=s2>&#34;</span><span class=nv>$OUTPUT_DIR</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>[</span> ! -d <span class=s2>&#34;</span><span class=nv>$OUTPUT_DIR</span><span class=s2>&#34;</span> <span class=o>]</span> <span class=o>||</span> <span class=o>[</span> ! -w <span class=s2>&#34;</span><span class=nv>$OUTPUT_DIR</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    error <span class=s2>&#34;Cannot access: &#39;</span><span class=nv>$OUTPUT_DIR</span><span class=s2>&#39;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>  <span class=k>fi</span>
</span></span><span class=line><span class=cl>  <span class=nv>OUTPUT_DIR</span><span class=o>=</span><span class=k>$(</span>realpath <span class=s2>&#34;</span><span class=nv>$OUTPUT_DIR</span><span class=s2>&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>shift</span> <span class=k>$((</span>OPTIND <span class=o>-</span> <span class=m>1</span><span class=k>))</span>
</span></span><span class=line><span class=cl><span class=o>[</span> <span class=nv>$#</span> -eq <span class=m>0</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> _exit
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>do_ffmpeg<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>[</span> -f <span class=s2>&#34;</span><span class=nv>$2</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    error <span class=s2>&#34;File already exists: &#39;</span><span class=nv>$2</span><span class=s2>&#39;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>  <span class=k>fi</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> ffmpeg -nostdin -v error -hide_banner -stats -i <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span> -map <span class=m>0</span> -c copy -c:v:0 <span class=s2>&#34;</span><span class=nv>$ENCODER</span><span class=s2>&#34;</span> <span class=nv>$ARGUMENTS</span> -tag:v:0 hvc1 <span class=s2>&#34;</span><span class=nv>$2</span><span class=s2>&#34;</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    error <span class=s2>&#34;==&gt; &#39;</span><span class=nv>$2</span><span class=s2>&#39;&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>    rm -f <span class=s2>&#34;</span><span class=nv>$2</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>  <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>FAIL_LIST</span><span class=o>=</span><span class=k>$(</span>mktemp<span class=k>)</span> <span class=o>||</span> <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=nb>trap</span> <span class=s1>&#39;rm -f &#34;$FAIL_LIST&#34;&#39;</span> EXIT
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>count</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl><span class=nv>total</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$#</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>for</span> f in <span class=s2>&#34;</span><span class=nv>$@</span><span class=s2>&#34;</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  error <span class=s2>&#34;</span><span class=nv>$THIN_LINE</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  error <span class=s2>&#34;==&gt; </span><span class=nv>$count</span><span class=s2>/</span><span class=nv>$total</span><span class=s2>: &#39;</span><span class=nv>$f</span><span class=s2>&#39;&#34;</span>
</span></span><span class=line><span class=cl>  : <span class=k>$((</span><span class=nv>count</span> <span class=o>+=</span> <span class=m>1</span><span class=k>))</span>
</span></span><span class=line><span class=cl>  <span class=nv>vc</span><span class=o>=</span><span class=k>$(</span>ffprobe <span class=s2>&#34;</span><span class=nv>$f</span><span class=s2>&#34;</span> -v error -select_streams v:0 -show_entries <span class=nv>stream</span><span class=o>=</span>codec_name -of <span class=nv>default</span><span class=o>=</span><span class=nv>noprint_wrappers</span><span class=o>=</span>1:nokey<span class=o>=</span><span class=m>1</span> <span class=p>|</span> head -n 1<span class=k>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>[</span> -z <span class=s2>&#34;</span><span class=nv>$vc</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    error <span class=s2>&#34;Unknown input: &#39;</span><span class=nv>$f</span><span class=s2>&#39;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$f</span><span class=s2>&#34;</span> &gt;&gt;<span class=s2>&#34;</span><span class=nv>$FAIL_LIST</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>continue</span>
</span></span><span class=line><span class=cl>  <span class=k>fi</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> contains <span class=s2>&#34;</span><span class=nv>$CODEC_WHITELIST</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$vc</span><span class=s2>&#34;</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    error <span class=s2>&#34;Skipping codec: &#39;</span><span class=nv>$vc</span><span class=s2>&#39;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>continue</span>
</span></span><span class=line><span class=cl>  <span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>[</span> -n <span class=s2>&#34;</span><span class=nv>$OUTPUT_DIR</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nv>output</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$OUTPUT_DIR</span><span class=s2>/</span><span class=k>$(</span>basename <span class=s2>&#34;</span><span class=nv>$f</span><span class=s2>&#34;</span><span class=k>)</span><span class=s2>.HEVC.mp4&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=nv>output</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$f</span><span class=s2>.HEVC.mp4&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>fi</span>
</span></span><span class=line><span class=cl>  do_ffmpeg <span class=s2>&#34;</span><span class=nv>$f</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$output</span><span class=s2>&#34;</span> <span class=o>&amp;&amp;</span> <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  error <span class=s2>&#34;Unable to use MP4 container, retrying with MKV&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nv>output</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>output</span><span class=p>%.*</span><span class=si>}</span><span class=s2>.mkv&#34;</span>
</span></span><span class=line><span class=cl>  do_ffmpeg <span class=s2>&#34;</span><span class=nv>$f</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$output</span><span class=s2>&#34;</span> <span class=o>&amp;&amp;</span> <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  error <span class=s2>&#34;Unable to use MKV container&#34;</span>
</span></span><span class=line><span class=cl>  error <span class=s2>&#34;Skipping file: &#39;</span><span class=nv>$f</span><span class=s2>&#39;&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$f</span><span class=s2>&#34;</span> &gt;&gt;<span class=s2>&#34;</span><span class=nv>$FAIL_LIST</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> -s <span class=s2>&#34;</span><span class=nv>$FAIL_LIST</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  error <span class=s2>&#34;</span><span class=nv>$BOLD_LINE</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  error <span class=s2>&#34;Unable to encode the following </span><span class=k>$(</span>wc -l &lt;<span class=s2>&#34;</span><span class=nv>$FAIL_LIST</span><span class=s2>&#34;</span> <span class=p>|</span> xargs<span class=k>)</span><span class=s2> files:&#34;</span>
</span></span><span class=line><span class=cl>  cat <span class=s2>&#34;</span><span class=nv>$FAIL_LIST</span><span class=s2>&#34;</span> &gt;<span class=p>&amp;</span><span class=m>2</span>
</span></span><span class=line><span class=cl>  <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span></code></pre></div></figure><h4 id=已知问题>已知问题</h4><p>一些视频除了视频流、音频流、字幕流外，还带有数据流、附件流，这些流可能无法在转码后的容器中支持（即使转码前后容器相同）<sup id=fnref:11><a href=#fn:11 class=footnote-ref role=doc-noteref>11</a></sup>。以下是一个容器无法支持数据流的报错：</p><pre tabindex=0><code>[mp4 @ 0x55af0c59d0c0] Could not find tag for codec none in stream #3, codec not currently supported in container
Could not write header for output file #0 (incorrect codec parameters ?): Invalid argument
Error initializing output stream 0:0 --
Unable to use MP4 container, retrying with MKV
[matroska @ 0x55ceccef70c0] Only audio, video, and subtitles are supported for Matroska.
Could not write header for output file #0 (incorrect codec parameters ?): Invalid argument
Error initializing output stream 0:0 --
</code></pre><p>此时可以手动转码并使用 <code>-map -0:d</code> 丢弃数据流：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ ffmpeg -i input.mp4 -map <span class=m>0</span> -map -0:d -c copy -c:v libx265 output.mp4
</span></span></code></pre></div><p>另外，由于脚本只使用 MP4 和 MKV 尝试，也可能存在不支持的音频流和字幕流等<sup id=fnref:12><a href=#fn:12 class=footnote-ref role=doc-noteref>12</a></sup>，此时也可以按需转码或丢弃，例如音频转码 <code>-c:a acc</code>，丢弃字幕 <code>-map -0:s</code>。</p><h4 id=示例>示例</h4><h5 id=批量转码>批量转码</h5><p>支持通配符：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ hevcize.sh /path/to/videos/1.mp4 /path/to/videos/2/3.avi /path/to/videos/4/5/6.mkv
</span></span><span class=line><span class=cl>$ hevcize.sh /path/to/videos/*.mp4
</span></span></code></pre></div><p>将 <code>/path/to/videos</code> 下所有文件进行转码，结果保存在当前目录：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ find /path/to/videos -type f -exec hevcize.sh -o . <span class=o>{}</span> +
</span></span></code></pre></div><h5 id=显卡加速>显卡加速</h5><p>比如 NVIDIA 显卡可以使用 hevc_nvenc 编码器进行加速，Intel 显卡使用 hevc_qsv，这些都需要硬件和驱动支持。</p><p>macOS 使用 hevc_videotoolbox 编码器进行显卡加速（<code>hevcize.sh -h</code> 查看有哪些可用编码器）：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ hevecize.sh -e hevc_videotoolbox /path/to/videos/1.mp4
</span></span><span class=line><span class=cl>--------------------------------------------------------------------------------
</span></span><span class=line><span class=cl><span class=o>==</span>&gt; 1/1: <span class=s1>&#39;/path/to/videos/1.mp4&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>frame</span><span class=o>=</span> <span class=m>8000</span> <span class=nv>fps</span><span class=o>=</span> <span class=m>80</span> <span class=nv>q</span><span class=o>=</span>-0.0 <span class=nv>Lsize</span><span class=o>=</span>   15000kB <span class=nv>time</span><span class=o>=</span>00:05:00.00 <span class=nv>bitrate</span><span class=o>=</span> 500.0kbits/s <span class=nv>dup</span><span class=o>=</span><span class=m>33</span> <span class=nv>drop</span><span class=o>=</span><span class=m>23</span> <span class=nv>speed</span><span class=o>=</span>3.00x    
</span></span><span class=line><span class=cl><span class=o>==</span>&gt; <span class=s1>&#39;/path/to/videos/1.mp4.HEVC.mp4&#39;</span>
</span></span></code></pre></div><p>显卡加速转码很快，CPU 占用率低，但比起默认的 libx265（CPU 软编码）质量较差。</p><p>通过 <code>-a &lt;args></code> 可以传递更多参数给 ffmpeg。</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://superuser.com/a/141343 target=_blank rel="noopener noreferrer">https://superuser.com/a/141343</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://superuser.com/a/432379 target=_blank rel="noopener noreferrer">https://superuser.com/a/432379</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=https://stackoverflow.com/a/31683689 target=_blank rel="noopener noreferrer">https://stackoverflow.com/a/31683689</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p><a href=https://video.stackexchange.com/a/4571 target=_blank rel="noopener noreferrer">https://video.stackexchange.com/a/4571</a>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p><a href=https://stackoverflow.com/a/51002586 target=_blank rel="noopener noreferrer">https://stackoverflow.com/a/51002586</a>&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:6><p><a href=https://stackoverflow.com/a/49373401 target=_blank rel="noopener noreferrer">https://stackoverflow.com/a/49373401</a>&#160;<a href=#fnref:6 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:7><p><a href=https://video.stackexchange.com/a/17397 target=_blank rel="noopener noreferrer">https://video.stackexchange.com/a/17397</a>&#160;<a href=#fnref:7 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:8><p><a href=https://trac.ffmpeg.org/wiki/How%20to%20speed%20up%20/%20slow%20down%20a%20video target=_blank rel="noopener noreferrer">https://trac.ffmpeg.org/wiki/How%20to%20speed%20up%20/%20slow%20down%20a%20video</a>&#160;<a href=#fnref:8 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:9><p><a href=https://video.stackexchange.com/a/17739 target=_blank rel="noopener noreferrer">https://video.stackexchange.com/a/17739</a>&#160;<a href=#fnref:9 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:10><p><a href=https://stackoverflow.com/a/46540577 target=_blank rel="noopener noreferrer">https://stackoverflow.com/a/46540577</a>&#160;<a href=#fnref:10 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:11><p><a href=https://stackoverflow.com/a/69529533 target=_blank rel="noopener noreferrer">https://stackoverflow.com/a/69529533</a>&#160;<a href=#fnref:11 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:12><p><a href=https://en.wikipedia.org/wiki/Comparison_of_video_container_formats target=_blank rel="noopener noreferrer">https://en.wikipedia.org/wiki/Comparison_of_video_container_formats</a>&#160;<a href=#fnref:12 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></article><section class="article labels"><a class=tag href=/tags/ffmpeg/>FFmpeg</a><a class=tag href=/tags/shell/>Shell</a><a class=tag href=/tags/linux/>Linux</a><a class=tag href=/tags/macos/>macOS</a></section><section class="article license"><p xmlns:cc=http://creativecommons.org/ns# style=text-align:center>本作品根据 <a href=http://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank rel="license noopener noreferrer" style=display:inline-block>署名-非商业性使用-相同方式共享 4.0 国际许可<img style=height:15px!important;margin-left:1px;vertical-align:text-bottom src=/cc-icons/cc.svg><img style=height:15px!important;margin-left:1px;vertical-align:text-bottom src=/cc-icons/by.svg><img style=height:15px!important;margin-left:1px;vertical-align:text-bottom src=/cc-icons/nc.svg><img style=height:15px!important;margin-left:1px;vertical-align:text-bottom src=/cc-icons/sa.svg></a> 进行授权。</p></section></div><div class="article bottom"><section class="article navigation"><p><a class=link href=/posts/do-not-use-grep-with--v-to-check-whether-file-does-not-contain-a-specific-string/><span class="iconfont icon-article"></span>不要使用 grep -v 来检查文件是否不包含特定字符串</a></p><p><a class=link href=/posts/send-email-with-exim4-in-linux/><span class="iconfont icon-article"></span>在 Linux 上使用 Exim4 发送邮件</a></p></section><section class="article discussion"><script>function loadComment(){let e=document.createElement("script");e.src="https://utteranc.es/client.js",e.setAttribute("repo","qianbinbin/qianbinbin.github.io"),e.setAttribute("issue-term","pathname"),e.setAttribute("theme","preferred-color-scheme"),e.setAttribute("crossorigin","anonymous"),e.setAttribute("async",""),document.querySelector("section.article.discussion").innerHTML="",document.querySelector("section.article.discussion").appendChild(e)}loadComment(),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{loadComment()})</script></section></div></section><section id=footer><div class=footer-wrap><p class=copyright>© 2017-2024 Binac.</p></div></section><script async src="https://www.googletagmanager.com/gtag/js?id=G-N7VZY53PLB"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-N7VZY53PLB")}</script><script src=https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js></script><script>addBackToTop({diameter:42})</script></body></html>