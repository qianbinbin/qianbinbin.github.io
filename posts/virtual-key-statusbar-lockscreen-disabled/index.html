<!doctype html><html lang=zh><meta charset=utf-8><meta name=generator content="Hugo 0.136.2"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light dark"><meta name=supported-color-schemes content="light dark"><link rel=icon href=/favicons/favicon.svg><title>分析和解决手机重启若干次后，虚拟按键、状态栏等失效的问题&nbsp;&ndash;&nbsp;Binac</title><link rel=stylesheet href=/css/core.min.d30edcc615d78b7f8a2a9e5f1b66bd074a7ad2e94b579fa5902d0967ce0f7684b300ef3a9e15d41af82c75f3fb951d4b.css integrity=sha384-0w7cxhXXi3+KKp5fG2a9B0p60ulLV5+lkC0JZ84PdoSzAO86nhXUGvgsdfP7lR1L><meta name=twitter:card content="summary">
<meta name=twitter:title content="分析和解决手机重启若干次后，虚拟按键、状态栏等失效的问题"><body><section id=header><div class="header wrap"><span class="header left-side"><a class="site home" href=/><img class="site logo" src=/favicons/favicon.svg alt><span class="site name">Binac</span></a></span>
<span class="header right-side"><div class="nav wrap"><nav class=nav><a class='nav item active' href=/posts/ title=文章>文章</a>
<a class='nav item' href=/nonsense/ title=妄言>妄言</a>
<a class='nav item' href=/tuya/ title=涂鸦>涂鸦</a>
<a class='nav item' href=/tags/ title>标签</a></nav></div></span></div></section><section id=content><div class=article-container><section class="article header"><h1 class="article title">分析和解决手机重启若干次后，虚拟按键、状态栏等失效的问题</h1><p class="article date">2017-09-19</p></section><article class="article markdown-body"><p>Android 有种特殊的 App 叫老化测试工具，一般包括若干次重启、存储读写、音频播放、视频播放等流程，是一个预装在手机的 APK，出厂时会去掉。</p><p>测试做老化测试挂机 24 小时后，手机概率性出现问题，现象主要包括** Home 键和 Recent 键不能用、无法下拉快捷设置和通知栏、锁屏失效、开发者模式无法打开**等。复现概率很低，每台重启 50 次，10 台中出现 0 ~ 3 台。诡异的是，我这边也会每天挂机，但一台都没有复现。</p><p>这个问题严重、紧急且困难。对于用户来说，出现问题后，重启手机是不能解决的，只能恢复出厂设置。而且出现问题的都是测试使用的 user 正式版本，几天才会出一个新版本，而我们工程师使用的 userdebug 版本从未复现，这也给 debug 造成了麻烦。</p><h2 id=分析过程>分析过程</h2><h3 id=开机向导>开机向导</h3><p>手机出现的这些症状，经历过 Android 5.0 ROM 开发的人可能似曾相识。如果手机预装了 Google 开机向导 SetupWizard.apk，那么你一定会记得首次开机必须登录 Google 账户的脑残设定。虽然这一做法无可厚非，但由于众所周知的原因，天朝无法访问 Google 服务器，所以作为 ROM 开发人员，如果没有能稳定爬梯的 Wi-Fi，就不得不八仙过海各显神通了。</p><p>我的做法简单粗暴，刷好 userdebug 或者 eng 版本，首次开机直接<code>adb shell</code>进去删除 SetupWizard.apk，手机就直接跳过了开机向导进入 Launcher。实际上开机向导和 Launcher 本质上一样，都为默认 Activity 添加了<code>android.intent.category.HOME</code>的 filter，只不过开机向导具有更高的优先级。</p><p>但这一做法是有问题的，其症状和这次问题的现象完全一样。原因是开机向导完成时，会写入两个重要的属性：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Settings</span><span class=p>.</span><span class=na>Global</span><span class=p>.</span><span class=na>putInt</span><span class=p>(</span><span class=n>getContentResolver</span><span class=p>(),</span><span class=w> </span><span class=n>Settings</span><span class=p>.</span><span class=na>Global</span><span class=p>.</span><span class=na>DEVICE_PROVISIONED</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Settings</span><span class=p>.</span><span class=na>Secure</span><span class=p>.</span><span class=na>putInt</span><span class=p>(</span><span class=n>getContentResolver</span><span class=p>(),</span><span class=w> </span><span class=n>Settings</span><span class=p>.</span><span class=na>Secure</span><span class=p>.</span><span class=na>USER_SETUP_COMPLETE</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>这两个属性表示手机已经设置完成，设备处于可用状态了。如果没有写入，那么手机很多功能都不能正常工作。在没有内置 SetupWizard.apk 的 AOSP 中，这个任务由源码树下<code>packages/apps/Provision/</code>来完成。如果内置了 SetupWizard.apk，则 Provision.apk 会被覆盖。</p><p>我对问题机测试了两个属性：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ adb shell settings get global device_provisioned
</span></span><span class=line><span class=cl><span class=m>0</span>
</span></span><span class=line><span class=cl>$ adb shell settings get secure user_setup_complete
</span></span><span class=line><span class=cl><span class=m>0</span>
</span></span></code></pre></div><p>果然属性是不对的。再将正确的值 put 进去，手机就正常了。</p><p>考虑到 Google 的开机向导完成后，我们还会显示一个定制界面，这个界面走完后 SetupWizard.apk 才会写入这两个属性。所以我首先怀疑开机向导有问题，尤其是定制部分，并推断这个 bug 不是跑老化后出现的，一定是第一次开机就有问题了，只不过测试当时没有注意。我特意叮嘱测试，刷机后第一次开机就要确认是不是就有问题。</p><p>就在我们打算去掉定制界面、进行压力测试以验证我的想法时，我被迅速打脸。20 台机器又复现了 4 台，并且测试确认第一次开机是正常的。这就非常尴尬。</p><h3 id=老化测试>老化测试</h3><p>既然开机向导没有问题，比较有可能的就是老化测试了，它包括很多步骤，其中最令人注意的就是重启 50 次。</p><p>之前提到问题的原因是属性值不正确，从 log 中看，此时 Keyguard 会打印错误 log：</p><pre tabindex=0><code>KeyguardViewMediator: doKeyguard: not showing because device isn&#39;t provisioned and the sim is not locked or missing
</code></pre><p>查看 log 发现，第一次复现的 3 台机器中，有两台是第一次重启后就报了这个错误，剩下一台是 50 次重启跑完后报了这个错误。手机出错时间肯定在 log 报错之前，于是我转向怀疑是 50 次重启过程中出了问题。</p><p>但是重启测试的核心代码非常简单，没有什么特别的地方：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>PowerManager</span><span class=w> </span><span class=n>pm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>PowerManager</span><span class=p>)</span><span class=w> </span><span class=n>getSystemService</span><span class=p>(</span><span class=n>Context</span><span class=p>.</span><span class=na>POWER_SERVICE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pm</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>pm</span><span class=p>.</span><span class=na>reboot</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>从 log 中分析关机和开机流程，也没发现可疑的地方。</p><h3 id=初步规避方案>初步规避方案</h3><p>与龙哥讨论后，开始尝试规避方案，即在开机进入 Launcher 时判断这两个属性是否正确，如果不正确则重新写入。但老大否决了这个方案，原因是这个问题非常严重，应该找出问题的根源，这个根源可能会同时引起其它问题，而不仅仅是两个属性值。时间非常紧迫，看来 deadline 之前是解决不了了，但事实证明老大的想法是明智的。</p><p>与此同时我也在可疑的地方添加了 log，打印包名和调用栈信息，看到底是什么程序修改了这两个属性。Android 提供给第三方读写这两个属性的接口在<code>frameworks/base/core/java/android/provider/Settings.java</code>中，最终数据的存取是在 SettingsProvider 模块中。</p><p>但 Settings.java 中添加的 log 并没有什么卵用。</p><p>之前为了方便 debug，龙哥建议我用 QFIL 给问题机半擦烧写了一个 userdebug 的 bootimage（只是不时会有点问题）。另一同事发现这两个属性最终保存在<code>/data/system/users/0/</code>下的 XML 文件中，他将<code>settings_global.xml</code>导出，发现写入属性的值为默认，包名为<code>android</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;setting</span> <span class=na>id=</span><span class=s>&#34;19&#34;</span> <span class=na>name=</span><span class=s>&#34;device_provisioned&#34;</span> <span class=na>value=</span><span class=s>&#34;0&#34;</span> <span class=na>package=</span><span class=s>&#34;android&#34;</span> <span class=nt>/&gt;</span>
</span></span></code></pre></div><p>另一个属性也是类似，但保存在<code>settings_secure.xml</code>文件中。</p><p>这说明这两个错误属性值应该是由 framework 来写的，十有八九就是 SettingsProvider 本身。这意味着可能是我们的源码中出现了系统级别的错误，而不是什么开机向导或者第三方应用导致的。</p><p>初步规避方案宣告失败。</p><h3 id=settingsprovider>SettingsProvider</h3><p>同事把导出的 XML 文件与正常的文件做了对比，发现错误的 XML 文件总是把其它属性也写成系统默认值。也就是说，很可能是原来正常的文件丢失了，系统重新生成了一份。</p><p>我分析源码发现，Settings.java 通过 binder 机制调用 SettingsProvider 模块来完成数据的存取，最终是在 SettingsState.java 中读写 XML 文件的。</p><p>SettingsState 中维护了一个 mStatePersistFile 对象，这是一个 File 类型对象，指代当前的 XML 文件。事实上用于存取数据的 XML 文件一共有三个，每个都对应一个 SettingsState 对象：</p><pre tabindex=0><code>/data/system/users/0/settings_system.xml
/data/system/users/0/settings_secure.xml
/data/system/users/0/settings_global.xml
</code></pre><p>原本这些数据保存在数据库中，从 Android 6.0 开始会迁移到 XML 文件，默认情况下还会在迁移后删除数据库文件<code>settings.db</code>。</p><p>在分析 XML 文件如何读写之前，需要先了解一下 AtomicFile。</p><h4 id=atomicfile>AtomicFile</h4><p>AtomicFile 让文件的写入变为原子操作，然而阅读源码可以发现，它并不是线程安全的。</p><p>它的原理非常简单，就是在写入文件时为原文件创建一个扩展名为<code>.bak</code>的备份文件。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// frameworks/base/core/java/android/util/AtomicFile.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>AtomicFile</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>File</span><span class=w> </span><span class=n>mBaseName</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>File</span><span class=w> </span><span class=n>mBackupName</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Create a new AtomicFile for a file located at the given File path.
</span></span></span><span class=line><span class=cl><span class=cm>     * The secondary backup file will be the same file path with &#34;.bak&#34; appended.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>AtomicFile</span><span class=p>(</span><span class=n>File</span><span class=w> </span><span class=n>baseName</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mBaseName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>baseName</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mBackupName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>File</span><span class=p>(</span><span class=n>baseName</span><span class=p>.</span><span class=na>getPath</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;.bak&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Start a new write operation on the file.  This returns a FileOutputStream
</span></span></span><span class=line><span class=cl><span class=cm>     * to which you can write the new file data.  The existing file is replaced
</span></span></span><span class=line><span class=cl><span class=cm>     * with the new data.  You &lt;em&gt;must not&lt;/em&gt; directly close the given
</span></span></span><span class=line><span class=cl><span class=cm>     * FileOutputStream; instead call either {@link #finishWrite(FileOutputStream)}
</span></span></span><span class=line><span class=cl><span class=cm>     * or {@link #failWrite(FileOutputStream)}.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;p&gt;Note that if another thread is currently performing
</span></span></span><span class=line><span class=cl><span class=cm>     * a write, this will simply replace whatever that thread is writing
</span></span></span><span class=line><span class=cl><span class=cm>     * with the new file being written by this thread, and when the other
</span></span></span><span class=line><span class=cl><span class=cm>     * thread finishes the write the new write operation will no longer be
</span></span></span><span class=line><span class=cl><span class=cm>     * safe (or will be lost).  You must do your own threading protection for
</span></span></span><span class=line><span class=cl><span class=cm>     * access to AtomicFile.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>FileOutputStream</span><span class=w> </span><span class=nf>startWrite</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Rename the current file so it may be used as a backup during the next read</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mBaseName</span><span class=p>.</span><span class=na>exists</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mBackupName</span><span class=p>.</span><span class=na>exists</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mBaseName</span><span class=p>.</span><span class=na>renameTo</span><span class=p>(</span><span class=n>mBackupName</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Log</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=s>&#34;AtomicFile&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Couldn&#39;t rename file &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mBaseName</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>+</span><span class=w> </span><span class=s>&#34; to backup file &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mBackupName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mBaseName</span><span class=p>.</span><span class=na>delete</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>FileOutputStream</span><span class=w> </span><span class=n>str</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>str</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FileOutputStream</span><span class=p>(</span><span class=n>mBaseName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>FileNotFoundException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>File</span><span class=w> </span><span class=n>parent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mBaseName</span><span class=p>.</span><span class=na>getParentFile</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>parent</span><span class=p>.</span><span class=na>mkdirs</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IOException</span><span class=p>(</span><span class=s>&#34;Couldn&#39;t create directory &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mBaseName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>FileUtils</span><span class=p>.</span><span class=na>setPermissions</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>parent</span><span class=p>.</span><span class=na>getPath</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>FileUtils</span><span class=p>.</span><span class=na>S_IRWXU</span><span class=o>|</span><span class=n>FileUtils</span><span class=p>.</span><span class=na>S_IRWXG</span><span class=o>|</span><span class=n>FileUtils</span><span class=p>.</span><span class=na>S_IXOTH</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>-</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>str</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FileOutputStream</span><span class=p>(</span><span class=n>mBaseName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>FileNotFoundException</span><span class=w> </span><span class=n>e2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IOException</span><span class=p>(</span><span class=s>&#34;Couldn&#39;t create &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mBaseName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>str</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Call when you have successfully finished writing to the stream
</span></span></span><span class=line><span class=cl><span class=cm>     * returned by {@link #startWrite()}.  This will close, sync, and
</span></span></span><span class=line><span class=cl><span class=cm>     * commit the new data.  The next attempt to read the atomic file
</span></span></span><span class=line><span class=cl><span class=cm>     * will return the new file stream.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>finishWrite</span><span class=p>(</span><span class=n>FileOutputStream</span><span class=w> </span><span class=n>str</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>str</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>FileUtils</span><span class=p>.</span><span class=na>sync</span><span class=p>(</span><span class=n>str</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>str</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mBackupName</span><span class=p>.</span><span class=na>delete</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Log</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=s>&#34;AtomicFile&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;finishWrite: Got exception:&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Call when you have failed for some reason at writing to the stream
</span></span></span><span class=line><span class=cl><span class=cm>     * returned by {@link #startWrite()}.  This will close the current
</span></span></span><span class=line><span class=cl><span class=cm>     * write stream, and roll back to the previous state of the file.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>failWrite</span><span class=p>(</span><span class=n>FileOutputStream</span><span class=w> </span><span class=n>str</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>str</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>FileUtils</span><span class=p>.</span><span class=na>sync</span><span class=p>(</span><span class=n>str</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>str</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mBaseName</span><span class=p>.</span><span class=na>delete</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mBackupName</span><span class=p>.</span><span class=na>renameTo</span><span class=p>(</span><span class=n>mBaseName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Log</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=s>&#34;AtomicFile&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;failWrite: Got exception:&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Open the atomic file for reading.  If there previously was an
</span></span></span><span class=line><span class=cl><span class=cm>     * incomplete write, this will roll back to the last good data before
</span></span></span><span class=line><span class=cl><span class=cm>     * opening for read.  You should call close() on the FileInputStream when
</span></span></span><span class=line><span class=cl><span class=cm>     * you are done reading from it.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;p&gt;Note that if another thread is currently performing
</span></span></span><span class=line><span class=cl><span class=cm>     * a write, this will incorrectly consider it to be in the state of a bad
</span></span></span><span class=line><span class=cl><span class=cm>     * write and roll back, causing the new data currently being written to
</span></span></span><span class=line><span class=cl><span class=cm>     * be dropped.  You must do your own threading protection for access to
</span></span></span><span class=line><span class=cl><span class=cm>     * AtomicFile.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>FileInputStream</span><span class=w> </span><span class=nf>openRead</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>FileNotFoundException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mBackupName</span><span class=p>.</span><span class=na>exists</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mBaseName</span><span class=p>.</span><span class=na>delete</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mBackupName</span><span class=p>.</span><span class=na>renameTo</span><span class=p>(</span><span class=n>mBaseName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FileInputStream</span><span class=p>(</span><span class=n>mBaseName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><code>openRead()</code>方法用于读取文件，返回原文件的 FileInputStream。如果发现备份文件存在，则说明当前有写入操作未完成，直接把备份文件恢复为原文件，这样原文件中总是干净的数据。</p><p><code>startWrite()</code>方法用于写入文件，返回原文件的 FileOutputStream。如果原文件存在，但备份文件不存在，则将创建一个备份。如果原文件存在且备份文件也存在，说明当前有写入操作未完成，直接把原文件删除。这样备份文件中总是干净的数据。当写入成功后，应调用<code>finishWrite()</code>来删除备份文件；当写入失败时，应调用<code>failWrite()</code>来将备份文件恢复为原文件。</p><p>线程安全问题由调用方考虑。</p><h4 id=xml-文件的读写>XML 文件的读写</h4><p>XML 文件的读取是在 SettingsState.java 的<code>readStateSyncLocked()</code>中：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// frameworks/base/packages/SettingsProvider/src/com/android/providers/settings/SettingsState.java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>readStateSyncLocked</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>FileInputStream</span><span class=w> </span><span class=n>in</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mStatePersistFile</span><span class=p>.</span><span class=na>exists</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Slog</span><span class=p>.</span><span class=na>i</span><span class=p>(</span><span class=n>LOG_TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;No settings state &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mStatePersistFile</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>addHistoricalOperationLocked</span><span class=p>(</span><span class=n>HISTORICAL_OPERATION_INITIALIZE</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>in</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicFile</span><span class=p>(</span><span class=n>mStatePersistFile</span><span class=p>).</span><span class=na>openRead</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>FileNotFoundException</span><span class=w> </span><span class=n>fnfe</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>message</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;No settings state &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mStatePersistFile</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Slog</span><span class=p>.</span><span class=na>wtf</span><span class=p>(</span><span class=n>LOG_TAG</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Slog</span><span class=p>.</span><span class=na>i</span><span class=p>(</span><span class=n>LOG_TAG</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>XmlPullParser</span><span class=w> </span><span class=n>parser</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Xml</span><span class=p>.</span><span class=na>newPullParser</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>parser</span><span class=p>.</span><span class=na>setInput</span><span class=p>(</span><span class=n>in</span><span class=p>,</span><span class=w> </span><span class=n>StandardCharsets</span><span class=p>.</span><span class=na>UTF_8</span><span class=p>.</span><span class=na>name</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>parseStateLocked</span><span class=p>(</span><span class=n>parser</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>XmlPullParserException</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>message</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;Failed parsing settings file: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mStatePersistFile</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Slog</span><span class=p>.</span><span class=na>wtf</span><span class=p>(</span><span class=n>LOG_TAG</span><span class=p>,</span><span class=w> </span><span class=n>message</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalStateException</span><span class=p>(</span><span class=n>message</span><span class=w> </span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>IoUtils</span><span class=p>.</span><span class=na>closeQuietly</span><span class=p>(</span><span class=n>in</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>XML 文件的写入是在<code>doWriteState()</code>中：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>doWriteState</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_PERSISTENCE</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Slog</span><span class=p>.</span><span class=na>i</span><span class=p>(</span><span class=n>LOG_TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;[PERSIST START]&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>AtomicFile</span><span class=w> </span><span class=n>destination</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AtomicFile</span><span class=p>(</span><span class=n>mStatePersistFile</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>version</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>ArrayMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Setting</span><span class=o>&gt;</span><span class=w> </span><span class=n>settings</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>mLock</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>version</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mVersion</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>settings</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayMap</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>mSettings</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mDirty</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mWriteScheduled</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>FileOutputStream</span><span class=w> </span><span class=n>out</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>out</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>destination</span><span class=p>.</span><span class=na>startWrite</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>XmlSerializer</span><span class=w> </span><span class=n>serializer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Xml</span><span class=p>.</span><span class=na>newSerializer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>serializer</span><span class=p>.</span><span class=na>setOutput</span><span class=p>(</span><span class=n>out</span><span class=p>,</span><span class=w> </span><span class=n>StandardCharsets</span><span class=p>.</span><span class=na>UTF_8</span><span class=p>.</span><span class=na>name</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>serializer</span><span class=p>.</span><span class=na>setFeature</span><span class=p>(</span><span class=s>&#34;http://xmlpull.org/v1/doc/features.html#indent-output&#34;</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>serializer</span><span class=p>.</span><span class=na>startDocument</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>serializer</span><span class=p>.</span><span class=na>startTag</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>TAG_SETTINGS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>serializer</span><span class=p>.</span><span class=na>attribute</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>ATTR_VERSION</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>.</span><span class=na>valueOf</span><span class=p>(</span><span class=n>version</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>settingCount</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>settings</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>settingCount</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Setting</span><span class=w> </span><span class=n>setting</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>settings</span><span class=p>.</span><span class=na>valueAt</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>writeSingleSetting</span><span class=p>(</span><span class=n>mVersion</span><span class=p>,</span><span class=w> </span><span class=n>serializer</span><span class=p>,</span><span class=w> </span><span class=n>setting</span><span class=p>.</span><span class=na>getId</span><span class=p>(),</span><span class=w> </span><span class=n>setting</span><span class=p>.</span><span class=na>getName</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>setting</span><span class=p>.</span><span class=na>getValue</span><span class=p>(),</span><span class=w> </span><span class=n>setting</span><span class=p>.</span><span class=na>getPackageName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_PERSISTENCE</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Slog</span><span class=p>.</span><span class=na>i</span><span class=p>(</span><span class=n>LOG_TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;[PERSISTED]&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>setting</span><span class=p>.</span><span class=na>getName</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>setting</span><span class=p>.</span><span class=na>getValue</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>serializer</span><span class=p>.</span><span class=na>endTag</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>TAG_SETTINGS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>serializer</span><span class=p>.</span><span class=na>endDocument</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>destination</span><span class=p>.</span><span class=na>finishWrite</span><span class=p>(</span><span class=n>out</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>mLock</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>addHistoricalOperationLocked</span><span class=p>(</span><span class=n>HISTORICAL_OPERATION_PERSIST</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG_PERSISTENCE</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Slog</span><span class=p>.</span><span class=na>i</span><span class=p>(</span><span class=n>LOG_TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;[PERSIST END]&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>t</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Slog</span><span class=p>.</span><span class=na>wtf</span><span class=p>(</span><span class=n>LOG_TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Failed to write settings, restoring backup&#34;</span><span class=p>,</span><span class=w> </span><span class=n>t</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>destination</span><span class=p>.</span><span class=na>failWrite</span><span class=p>(</span><span class=n>out</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>IoUtils</span><span class=p>.</span><span class=na>closeQuietly</span><span class=p>(</span><span class=n>out</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>逻辑很简单，似乎没什么特别的。</p><p>我在<code>doWriteState()</code>中添加了 log。几天后测试复现问题，分析 log 发现，出错时确实走到了这里，并且写入的属性为默认值，包名为<code>android</code>，这与 XML 文件中是一致的。但是为什么 SettingsProvider 会写入默认值，仍然不清楚。这种问题只能反复添加 log、等复现、分析 log，转眼又是好几天。</p><p>AtomicFile 实际上是 Java 中 File 类的一个封装，最终仍然是通过 File 类读写 XML 文件的，于是我又在 File 类中的读写删除等方法中添加 log，打印调用栈信息，至于如何添加的又是另一个故事了：<a href=/posts/print-log-in-libcore/>在 Android Java 核心库 libcore 中打印 Log</a></p><p>分析 log 发现确实是在 AtomicFile 中读写删的，其他地方对这些 XML 文件没有任何操作。</p><p>问题迟迟不能解决，引起了小 boss 的注意。小 boss 拉我们开了一个小会，由于怀疑是 50 次重启过程中出了问题，他让我们在重启之前和开机时分别打印<code>/data/system/users/0/</code>下的文件。说起来几句话，实际上实现起来并不简单，完全是吃力不讨好的活——这种活当然由我来干了。</p><p>因为关机和开机不是一瞬间的事，而是有很复杂的流程，在哪里打印 log，这是需要认真考虑的。我先在调用<code>PowerManager#reboot()</code>方法前和开机启动 SettingsProvider 时打印log，发现了奇怪的现象：问题出现时，前一次关机时是没有问题的，文件没有丢失，而开机后却丢失了，并且只剩下备份文件！</p><p>这说明：问题出现的时刻，要么是在调用<code>PowerManager#reboot()</code>关机之后，要么是在开机流程走到 ProviderService 之前。</p><p>终于有了一线生机，然而事情并不那么简单，开关机流程太复杂，一一排查的话，不知要排查到什么时候。</p><p>我接着分析：</p><ol><li><p>理论上讲，Android 只有 SettingsProvider 会去直接读写这些文件，其他地方哪怕是 framework 也要通过它来进行</p></li><li><p>Google 不会傻到在其他模块去读写，因此第三方 App 的嫌疑更大</p></li><li><p>ProviderService 是在 System Server 中启动的，这算是开机流程相当早的时候了，而此时第三方 App 根本就没有启动</p></li><li><p>与负责工模的龙哥确认，工模是不会读写这些文件的，公司内部的内置 App 也不会去读写</p></li></ol><p>于是，我将目光转向</p><ol><li><p>内置的第三方 App，并且</p></li><li><p>在关机的时候，有系统设置读写操作</p></li></ol><h3 id=内置的第三方-app>内置的第三方 App</h3><p>除 AOSP 自带和公司内置 App 外，还有一些客户提供或第三方外包公司开发的 App，这些 App 我们都没有源码。</p><p>一种方法就是把可疑的 App 列出，逐个去掉其中一个，然后跑测试。但这几乎不可行，不仅是因为以上都是推测，即使知道确实是第三方 App 搞的鬼，排查下来也要数周时间。</p><p>就在这时，真是柳暗花明又一村，我对比了几次问题出现的前一次关机的 log，发现有两三次有同一个第三方 App 疑似读写系统设置。但是为什么其他 log 中没有呢？</p><p>我调查了这个 App，它和手机保修有关，是一个印度外包公司做的。接着我又发现了诡异的现象……</p><p>开机，它都会自启；手动 kill 掉，一段时间后也会自启！这个可疑的 App，不仅不停地读写系统设置，而且开机自启，有着杀不死的进程保活机制！</p><p>我请教了龙哥，得到的回复是，即使是 T 卡 log，也会在调用<code>PowerManager#reboot()</code>不久后自动关闭，因此不是其他 log 中没有，而是根本打印不出来！</p><p>是的，这个时候连 T 卡 log 都关闭了，而这个 App 居然还活着！怪不得我们发现不了问题所在，打印不出有效的 log，怎么定位问题？</p><p>接下来的分析就顺理成章了：</p><ol><li><p>手机关机，关机流程，第三方 App、系统 App、特权 App、T 卡 log 等陆续关闭</p></li><li><p>这个第三方 App 做了进程保活，只有它不会被关闭，而且一直在读写系统设置</p></li><li><p>在某次写入系统设置时，AtomicFile 调用<code>startWrite()</code>方法，将原 XML 文件重命名为备份文件</p></li><li><p>恰好在这时，Android 系统关闭，而尚未调用<code>finishWrite()</code>方法写入，也无法调用<code>failWrite()</code>方法恢复，原 XML 文件丢失，只剩下备份文件</p></li><li><p>手机开机，调用 SettingsProvider 的<code>readStateSyncLocked()</code>方法，发现文件不存在，就重新创建了 XML 文件，且使用系统默认配置</p></li><li><p>至此，原 XML 文件彻底丢失，所有系统设置恢复默认，手机虚拟按键、状态栏等全部失效。</p></li></ol><p>那么为什么 userdebug 版本从未复现呢？我的推测是，userdebug 关机流程和 user 版本存在区别，userdebug 版本的关机 log 明显更多，流程也更长，在关机流程走完之前，这个 App 读写系统设置已经完成了。</p><p>我将此 App 从编译配置中去掉，又连续跑了几天测试都没有再复现问题。看来根因确实在这个奇葩的 App。</p><p>规避方案就很简单了，在<code>readStateSyncLocked()</code>方法中，如果发现原文件不存在，但备份文件存在，就把备份文件恢复为原文件，这样系统设置又恢复了。不过还是要让印度外包公司修复，彻底修复才是王道。</p><h2 id=尾声>尾声</h2><p>说到这我不得不吐槽印度人真是奇葩，我们把问题的前因后果都详细分析给印度外包公司，通知三哥赶紧确认是否有进程保活并一直读写系统配置，再三催促，人家根本不回答问题，然后突然更新了 APK，问我们——现在你们还能复现吗？</p><p>如果是我同事我可能当场就骂过去了，你他妈的不确认我们的问题，连修改了什么都不告诉我们，然后就让我们用新的 APK 复现？你知道我们花了多少人力多少时间在这个破问题上吗？你们有一点责任心吗？</p><p>至于道歉？呵呵，不存在的。</p><p>这个故事告诉我们，以后遇到阿三，一定要多留个心眼。</p><p>当然，为了防止阿三再次脑抽，我还是将规避方案加上去了。</p></article><section class="article labels"><a class=tag href=/tags/android/>Android</a></section><section class="article license"><p xmlns:cc=http://creativecommons.org/ns# style=text-align:center>本作品根据 <a href=http://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank rel="license noopener noreferrer" style=display:inline-block>署名-非商业性使用-相同方式共享 4.0 国际许可<img style=height:15px!important;margin-left:1px;vertical-align:text-bottom src=/cc-icons/cc.svg><img style=height:15px!important;margin-left:1px;vertical-align:text-bottom src=/cc-icons/by.svg><img style=height:15px!important;margin-left:1px;vertical-align:text-bottom src=/cc-icons/nc.svg><img style=height:15px!important;margin-left:1px;vertical-align:text-bottom src=/cc-icons/sa.svg></a> 进行授权。</p></section></div><div class="article bottom"><section class="article navigation"><p><a class=link href=/posts/gas-station/><span class="iconfont icon-article"></span>Gas Station</a></p><p><a class=link href=/posts/factory-pattern/><span class="iconfont icon-article"></span>工厂模式 Factory Pattern</a></p></section><section class="article discussion"><script>function loadComment(){let e=document.createElement("script");e.src="https://utteranc.es/client.js",e.setAttribute("repo","qianbinbin/qianbinbin.github.io"),e.setAttribute("issue-term","pathname"),e.setAttribute("theme","preferred-color-scheme"),e.setAttribute("crossorigin","anonymous"),e.setAttribute("async",""),document.querySelector("section.article.discussion").innerHTML="",document.querySelector("section.article.discussion").appendChild(e)}loadComment(),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{loadComment()})</script></section></div></section><section id=footer><div class=footer-wrap><p class=copyright>© 2017-2024 Binac.</p></div></section><script async src="https://www.googletagmanager.com/gtag/js?id=G-N7VZY53PLB"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-N7VZY53PLB")}</script><script src=https://unpkg.com/vanilla-back-to-top@7.2.1/dist/vanilla-back-to-top.min.js></script><script>addBackToTop({diameter:42})</script></body></html>