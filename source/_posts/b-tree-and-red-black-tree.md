---
title: B 树与红黑树
date: 2020-03-22 18:48:20
mathjax: true
tags:
- 算法
- 二叉树
---

红黑树是对 2-3-4 树（4 阶 B 树）的一种等同，理解 B 树就能理解红黑树。

<!-- more -->

# B 树

B 树理解起来既难也不难，主要是很多地方定义不统一，一旦定义清晰了就无所谓难了。都说宗教之争就是名词之争，对于理工科而言，如果连定义都不统一，只会造成混乱。比如：

1. 《算法导论》是通过最少子结点个数来定义阶数的，这就隐含地把阶数定义为偶数，而一般来说阶数可以为奇数。
2. Knuth 认为叶子层是最下面关键字之下的那一层，严蔚敏版《数据结构》沿用了这个定义，而《算法导论》中指的是最下面关键字的那一层，维基百科“B 树”的中英文词条中，定义和算法部分对叶结点的认识前后矛盾。
3. 《算法导论》把叶结点以外的结点都称为内部结点，而 Knuth 定义是除叶结点和根结点以外的结点，严蔚敏版《数据结构》又把叶结点称为终端结点，其他结点称为非终端结点。

B 树的实现比较复杂。

## 定义

![](https://upload.wikimedia.org/wikipedia/commons/thumb/6/65/B-tree.svg/799px-B-tree.svg.png)

<center>一棵 5 阶 B 树</center>

为了避免歧义，约定：

1. **底部结点**为最下面关键字的那一层结点。
2. **叶结点**为底部结点之下的那一层结点（即外部结点，图中未画出）。
3. **内部结点**为叶结点和根结点以外的结点。

**底部结点**是我自己发明的名词。

**m 阶 B 树是一个有以下属性的树：**

1. 每个结点最多有 m 个子结点。
2. 每个内部结点最少有 $\lceil m/2 \rceil$ 个子结点。
  （即最少有 $\lceil m/2 \rceil - 1$ 个关键字，意味着结点中关键字数量至少占一半空间）。
3. 根结点如果不是底部结点，则最少有 2 个子结点。
4. 非叶结点的 k - 1 个关键字将其 k 个子树分开，且对于每个键，左子树所有关键字都比之小、右子树所有关键字都比之大。
5. 所有叶结点在同一层。

其他都容易理解，为什么内部结点最少有 $\lceil m/2 \rceil$ 个子结点？为什么根结点可以最少有 2 个子结点？这两个问题可以在插入和删除算法中得到解答。

## 操作

### 搜索

与二叉搜索树（BST）类似，这里不赘述。

### 插入

![](https://upload.wikimedia.org/wikipedia/commons/3/33/B_tree_insertion_example.png)

<center>依次升序插入关键字，构造一棵 3 阶 B 树</center>

从根结点开始，搜索需插入的键直到底部结点：

1. 如果此结点空间未满，则直接插入。

2. 否则，从其所有键及新键中选择中位数，结点分裂为两个结点，比中位数小的放入左结点、大的放入右结点，中位数插入父结点。
  这可能会造成父结点满而分裂，依此类推，直到找到未满的结点，或直到根结点分裂，产生新的根结点，树的高度增加。

如果一直分裂到根结点，则新的根结点产生，而它有两个子结点，这就是根结点最少可以有 2 个子结点的原因。

《算法导论》提供的是一种单程插入算法，即只有向下的过程，不需要插入后向上回溯，为此在向下查找时就要分裂那些已满的结点，这种算法要求**阶数必须为偶数**。

依次把关键字插入到空的 B 树，就可以完成 B 树的创建。

### 删除

删除操作比插入稍微复杂一些，同样先搜索需删除的键所在结点：

1. 如果此结点是底部结点，则直接删除键，若结点下溢（关键字数量小于最小值），则还要按照下面的重新平衡策略进行调整。

2. 否则，搜索左子树中的最大键或右子树中的最小键（必然在底部结点中），删除它并进行必要的重新平衡调整，然后用它来替换掉被删除的键。

#### 删除后重新平衡

从底部结点到根结点进行，直到树重新平衡：

1. 如果结点左（右）兄弟存在且关键字数量多于最小值，则向右（左）旋转：
  1. 将父结点的分隔键移动到此结点。
  2. 将左（右）兄弟中的最大（小）键移动到父结点。

2. 否则，两个相邻兄弟都只有最少关键字，将此结点与任一相邻兄弟及父结点中它们的分隔键合并，成为一个新结点。
  如果父结点下溢，则继续重新平衡父结点，依此类推，直到父结点键数足够，或直到根结点。
  如果根结点没有关键字了，则删除它，最后合并的结点成为新的根结点，树的高度减小。

结点合并时一定不会上溢（关键字数量大于最大值），这就是规定内部结点最少子结点数为 $\lceil m/2 \rceil$ 的原因。

类似插入算法，《算法导论》提供的也是单程删除算法，在向下搜索过程中，就合并相邻最少关键字的结点，这样就保证删除底部结点中的键时一定不会下溢，因此不需要向上回溯，同样**要求阶数为偶数**。

# 红黑树

红黑树是一种二叉搜索树，与 2-3-4 树（4 阶 B 树）存在一一对应关系，红黑树本质上是利用二叉搜索树来实现 2-3-4 树。

2-3-4 树中结点的三种状态，对应红黑树中结点的三种状态：

![](https://azrael.digipen.edu/~mmead/www/Courses/CS280/RedBlack-234-Mapping-1.gif)

如果把红黑树中红色结点与其父结点合并，就变成了 2-3-4 树。

有的地方，如《算法》中会说红黑树是 2-3 树（3 阶 B 树）的一种等同，实际上指的是左倾红黑树，它规定红色结点只能在左边。比一般意义上的红黑树简单一些。

## 定义

![](https://upload.wikimedia.org/wikipedia/commons/thumb/6/66/Red-black_tree_example.svg/900px-Red-black_tree_example.svg.png)

约定叶结点指不含关键字的结点，与 B 树中的叶结点相当，即图中的 `NIL` 结点。

**红黑树是这样一棵二叉搜索树：**

1. 结点或是红色或是黑色。
2. 根结点为黑色。
3. 所有叶结点都是黑色。
4. 所有红色节点的子结点都为黑色。
  （从任一叶结点到根结点的路径上不能有两个连续的红色结点。）
5. 从任一结点到其每个叶结点的所有简单路径都包含相同数目的黑色结点。

从 4 阶 B 树入手，就能理解为什么会有这么奇怪的定义了。

上面已经指出了红黑树结点只有三种合法状态，红色结点的子结点不可能仍为红色，这就是性质 4。在 B 树中，任一非叶结点到其叶结点的路径都是相等的，对应红黑树的性质 5。

## 操作

### 搜索

同二叉搜索树。

### 旋转

在进行插入和删除操作时，红黑树结点的颜色和结构可能会进入非法状态，旋转操作可以改变某些结点的结构。

![](/images/b-tree-and-red-black-tree/red-black-tree-rotation.png)

<center>左旋、右旋</center>

### 插入

1. 按照与 BST 相同的方法插入结点，并将其标为红色（记为 z）。

   > 标为红色，就使其与父结点实际上处于对应 B 树中的同一个底部结点。

2. 如果 z 的父结点也是红色，则违反了性质 4，此时就要不断做调整，直到满足性质 4 为止：

  > 相当于 B 树中插入操作中的向上分裂。

   1. 如果 z 的父结点是左子结点，即 `z.parent == z.parent.parent.left`，

      1. **Case 1** 如果 z 的叔结点（父结点的兄弟结点） y 为红色，此时需进行颜色翻转，即将 z 的父结点、叔结点置为黑色，将祖父结点置为红色，然后将 z 指向祖父结点。

      > 此时，对应 B 树中有 4 个关键字处于同一结点。颜色翻转，就相当于关键字中选出中位数，结点分裂，中位数插入父结点。在 4 个关键字中选出中位数，无论 z 关键字大小如何，其祖父结点的关键字必定可以作为中位数。

      2. 如果 y 为黑色，

         1. **Case 2** 如果 z 是右子结点，则将 z 指向其父结点，并对 z 做左旋，转换为 Case 3。

         2. **Case 3** 如果 z 为左子结点，将 z 的父结点置为黑色、祖父结点置为红色，并对祖父结点做右旋。

      > 此时，对应 B 树中有 3 个关键字处于同一结点（即 4-结点），这在 4 阶 B 树中是合法的，但不满足红黑树的定义，因为 4-结点在红黑树中只有一种合法情形：结点为黑，左右子结点为红。因此需要进行旋转、修改颜色的操作。

   2. 如果 z 的父结点是右子结点，则进行与上面左右相反的操作。

   最后，将根结点置为黑色。

![](/images/b-tree-and-red-black-tree/red-black-tree-insertion.png)

<center>插入</center>

### 删除

## 平衡二叉树（AVL 树）与红黑树

两者都是自平衡二叉查找树。

平衡二叉树的每个结点需要记录左右子树的高度或高度差。

## 应用

# 源码

# 参考资料

1. 《算法导论》
2. 《数据结构》
3. 《算法》
4. [B树 - 维基百科，自由的百科全书](https://zh.wikipedia.org/wiki/B%E6%A0%91)
5. [Mapping 2-3-4 Trees into Red-Black Trees](https://azrael.digipen.edu/~mmead/www/Courses/CS280/Trees-Mapping2-3-4IntoRB.html)
